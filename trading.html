<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradeator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Web App Manifest para Android (Chrome) -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827"> 

    <!-- Iconos -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://weberia.neocities.org/stock.png" purpose="any maskable">
    <link rel="icon" type="image/png" sizes="512x512" href="https://weberia.neocities.org/stock.png" purpose="any maskable">

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tradeator">
    <link rel="apple-touch-icon" href="https://weberia.neocities.org/stock.png">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #F9FAFB;
        }
        .stock-up { color: #22C55E; }
        .stock-down { color: #EF4444; }
        .profit { color: #22C55E; }
        .loss { color: #EF4444; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
        .loader {
            border: 4px solid #4B5563;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #auth-view, #main-app-view { transition: opacity 0.5s ease-in-out; }
        .notification {
            transition: opacity 0.5s, transform 0.5s;
        }

        .leaderboard-first-place {
            background-color: #FFD700 !important; 
            color: #000000 !important; 
            font-weight: bold;
        }

        .leaderboard-your-entry {
            background-color: #FFFF00 !important; 
            color: #000000 !important; 
        }

        #global-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        #global-loading-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .chart-loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        .filter-btn {
            background-color: #374151;
            color: #D1D5DB;
            transition: background-color 0.2s, color 0.2s;
        }
        .filter-btn:hover {
            background-color: #4B5563;
        }
        .filter-btn.active {
            background-color: #3B82F6;
            color: #FFFFFF;
            font-weight: 600;
        }

        .tab-btn {
            background-color: transparent;
            color: #9CA3AF;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn.active {
            color: #3B82F6;
            border-bottom-color: #3B82F6;
            font-weight: 600;
        }
        .trade-row-buy { border-left: 4px solid #22C55E; }
        .trade-row-sell { border-left: 4px solid #EF4444; }

        /* Estilo para la estrella de favoritos */
        .star-icon {
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-icon.active {
            color: #FBBF24; /* Amber-400 */
            fill: #FBBF24;
        }
        .star-icon:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Global Loading Overlay -->
    <div id="global-loading-overlay">
        <div class="loader"></div>
        <p class="text-white text-lg mt-4">Cargando...</p>
    </div>

    <!-- Authentication View -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-8 bg-gray-800 rounded-lg shadow-lg">
            <div>
                <h2 id="auth-title" class="text-center text-3xl font-extrabold text-white">Tradeator</h2>
                <p class="mt-2 text-center text-sm text-gray-400">
                    O <a href="#" id="toggle-auth-mode" class="font-medium text-blue-400 hover:text-blue-300">crea una cuenta nueva</a>
                </p>
            </div>
            <form id="auth-form" class="space-y-6">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Usuario</label>
                        <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-gray-200 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Usuario">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Contrase침a</label>
                        <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-gray-200 rounded-b-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500" placeholder="Contrase침a">
                    </div>
                </div>
                <div>
                    <button type="submit" id="auth-submit-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">
                        <span id="auth-button-text">Iniciar Sesi칩n</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App View -->
    <div id="main-app-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Tradeator</h1>
                    <p id="welcome-message" class="text-gray-400">Bienvenido, ...</p>
                </div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <!-- NASDAQ Timer -->
                    <div class="w-48 text-center bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h2 id="timer-status" class="text-lg font-semibold text-gray-400">游 Nasdaq: Cargando...</h2>
                        <p id="timer-display" class="text-4xl font-bold text-orange-500 mt-1">--</p>
                    </div>

                    <!-- Portfolio Value -->
                    <div class="w-48 text-center bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold text-gray-400">Valor Total</h2>
                        <p id="total-value" class="text-3xl font-bold text-white">$1,000.00</p>
                        <div id="daily-profit-loss" class="mt-2 text-sm"></div>
                    </div>
                    
                    <button id="history-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Historial
                    </button>

                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Salir
                    </button>
                </div>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-gray-800/50 rounded-lg p-6 shadow-2xl">
                    
                    <!-- TABS -->
                    <div class="flex space-x-4 border-b border-gray-700 mb-4">
                        <button id="tab-market" class="tab-btn py-2 px-4 text-lg active">Mercado</button>
                        <button id="tab-favorites" class="tab-btn py-2 px-4 text-lg">Favoritos</button>
                        <button id="tab-triggers" class="tab-btn py-2 px-4 text-lg">Programaciones</button>
                    </div>

                    <!-- MARKET TAB -->
                    <div id="market-content">
                        <div class="flex justify-between items-center pb-2 mb-4">
                            <h2 class="text-2xl font-bold">Mercado de Acciones</h2>
                            <div id="api-status" class="flex items-center space-x-2">
                                <div id="market-loader" class="loader hidden"></div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-input" placeholder="Buscar s칤mbolo (ej. AAPL)..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        
                        <!-- Filters -->
                        <div id="filter-container" class="flex flex-wrap gap-2 mb-4">
                            <button class="filter-btn active py-2 px-4 rounded-md text-sm font-medium" data-filter="all">Todos</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="tech">Tecnolog칤a</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="etf">ETFs</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="toys">Juguetes</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="home">Hogar</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="finanzas">Finanzas</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="salud">Salud</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="consumo">Consumo</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="energia">Energ칤a</button>
                        </div>

                        <div class="flex justify-between space-x-2 mb-4">
                            <button id="top-gainers-button" class="w-1/3 bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition-colors">游릭拘勇</button>
                            <button id="top-losers-button" class="w-1/3 bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">游댮拘勇</button>
                            <button id="can-afford-button" class="w-1/3 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Al alcance</button>
                            <button id="ai-recommendations-button" class="w-1/4 bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-xs md:text-sm">九IA</button>
                        </div>
                        
                        <div id="daily-summary-section" class="bg-gray-700/50 p-4 rounded-lg mb-4">
                            <h3 class="text-xl font-bold text-white mb-2">Resumen Diario de la Bolsa</h3>
                            <p id="daily-summary-text" class="text-gray-300">Cargando resumen...</p>
                            <p id="daily-summary-error" class="text-red-400 hidden">Error al cargar el resumen diario.</p>
                        </div>
                        <div id="stock-market-list" class="space-y-4 max-h-[55vh] overflow-y-auto pr-2"></div>
                    </div>

                    <!-- FAVORITES TAB (New) -->
                    <div id="favorites-content" class="hidden">
                         <h2 class="text-2xl font-bold mb-4">Mis Acciones Favoritas</h2>
                         <div id="favorites-list" class="space-y-4 max-h-[55vh] overflow-y-auto pr-2"></div>
                    </div>

                    <!-- TRIGGERS TAB -->
                    <div id="triggers-content" class="hidden">
                        <h2 class="text-2xl font-bold mb-4">Programar Operaciones</h2>
                        <form id="create-trigger-form" class="bg-gray-900 p-4 rounded-lg mb-6 space-y-3">
                            <h3 class="text-xl font-semibold text-white">Crear Nueva Programaci칩n</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label for="trigger-symbol" class="block text-sm font-medium text-gray-300 mb-1">S칤mbolo (ej. NVDA)</label>
                                    <input type="text" id="trigger-symbol" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="NVDA">
                                </div>
                                <div>
                                    <label for="trigger-quantity" class="block text-sm font-medium text-gray-300 mb-1">Cantidad</label>
                                    <input type="number" id="trigger-quantity" min="1" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="10">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label for="trigger-action" class="block text-sm font-medium text-gray-300 mb-1">Acci칩n</label>
                                    <select id="trigger-action" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="sell">Vender (o Vender en Corto)</option>
                                        <option value="buy">Comprar (o Cubrir Corto)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="execution-type" class="block text-sm font-medium text-gray-300 mb-1">Tipo de Ejecuci칩n</label>
                                    <select id="execution-type" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="price">Precio (Condicional)</option>
                                        <option value="time">Tiempo (Programado)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="price-conditions" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label for="trigger-condition" class="block text-sm font-medium text-gray-300 mb-1">Condici칩n</label>
                                    <select id="trigger-condition" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="lt">Precio Baja &lt; (Stop-Loss)</option>
                                        <option value="gt">Precio Sube &gt; (Take-Profit)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="trigger-price" class="block text-sm font-medium text-gray-300 mb-1">Precio Objetivo (USD)</label>
                                    <input type="number" id="trigger-price" step="0.01" min="0" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="150.00">
                                </div>
                            </div>
                            <div id="time-conditions" class="grid grid-cols-1 md:grid-cols-2 gap-3 hidden">
                                <div>
                                    <label for="trigger-date" class="block text-sm font-medium text-gray-300 mb-1">Fecha de Ejecuci칩n</label>
                                    <input type="date" id="trigger-date" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                </div>
                                <div>
                                    <label for="trigger-time" class="block text-sm font-medium text-gray-300 mb-1">Hora de Ejecuci칩n (Espa침a, CET/CEST)</label>
                                    <input type="time" id="trigger-time" step="60" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                </div>
                            </div>
                            <button type="submit" id="trigger-submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Crear Programaci칩n</button>
                        </form>
                        <h3 class="text-xl font-bold text-white mb-2">Programaciones Activas</h3>
                        <div id="active-triggers-list" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="bg-gray-800/50 rounded-lg p-6 shadow-2xl">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-white mb-2">Efectivo Disponible</h3>
                        <p id="cash-balance" class="text-2xl font-semibold text-green-400">$0.00</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Tu Portafolio</h3>
                        <div id="portfolio-list" class="space-y-4 max-h-[30vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Clasificaci칩n Global</h3>
                        <div id="leaderboard-list" class="space-y-4 max-h-[25vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Modal -->
    <div id="trade-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 max-w-lg z-10">
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <div class="mb-4">
                <label for="shares-input" class="block text-sm font-medium text-gray-300 mb-1">Cantidad de acciones:</label>
                <input type="number" id="shares-input" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ej: 10">
            </div>
            <div class="mb-4">
                <p class="text-gray-400">Costo/Valor Total: <span id="modal-total-cost" class="font-bold text-white">$0.00</span></p>
                <p id="cash-remaining-label" class="text-gray-400">Efectivo restante: <span id="modal-cash-remaining" class="font-bold text-white">$0.00</span></p>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">Cancelar</button>
                <button id="confirm-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md font-semibold"></button>
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div id="chart-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 max-w-2xl z-10">
            <div class="flex justify-between items-center mb-4">
                <h2 id="chart-modal-title" class="text-2xl font-bold text-white"></h2>
                <button id="close-chart-modal-button" class="text-gray-400 hover:text-white text-xl font-bold">&times;</button>
            </div>
            <div id="chart-loader" class="chart-loader hidden"></div>
            <div id="tradingview-container" class="relative w-full h-[50vh] min-h-[300px] overflow-hidden"></div>
            <p id="chart-error-message" class="text-red-400 text-center mt-4 hidden">Error al cargar el gr치fico.</p>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-w-3xl z-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Historial de Transacciones</h2>
                <button id="close-history-modal-button" class="text-gray-400 hover:text-white text-xl font-bold">&times;</button>
            </div>
            <div class="bg-gray-900 p-3 rounded-t-lg grid grid-cols-5 md:grid-cols-6 gap-2 font-semibold border-b border-gray-700 sticky top-0">
                <div class="col-span-1">Acci칩n</div>
                <div class="col-span-1">S칤mbolo</div>
                <div class="hidden md:block">Cantidad</div>
                <div class="col-span-1">Precio</div>
                <div class="col-span-1">Fuente</div>
                <div class="col-span-1 text-right">Tiempo</div>
            </div>
            <div id="trade-history-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                <p id="history-loading-status" class="text-gray-400 text-center py-4">Cargando historial...</p>
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification-area" class="fixed bottom-5 right-5 space-y-2 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://finances.logise1123.workers.dev';
            const API_LIVE_VALUES_URL = 'https://finances.logise1123.workers.dev/livevalues';
            const WORKER_TRIGGER_SECRET = "YOUR_SUPER_SECRET_KEY_HERE_FOR_PRIVILEGED_EXECUTION";
            const SIGNUP_COOLDOWN_KEY = 'stock_simulator_last_signup';
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;
            const defaultSymbols = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'AMZN', 'NVDA', 'META', 'JPM', 'V', 'NFLX'];

            const PreloadedNames = {
                'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc. (Cl A)', 
                'NVDA': 'NVIDIA Corp.', 'META': 'Meta Platforms Inc.', 'TSLA': 'Tesla Inc.', 
                'AMD': 'Advanced Micro Devices', 'INTC': 'Intel Corp.',
                'SPY': 'SPDR S&P 500 ETF Trust', 'QQQ': 'Invesco QQQ Trust', 
                'VOO': 'Vanguard S&P 500 ETF', 'VTI': 'Vanguard Total Stock Mkt ETF', 
                'GLD': 'SPDR Gold Shares', 'SLV': 'iShares Silver Trust',
                'HAS': 'Hasbro Inc.', 'MAT': 'Mattel Inc.',
                'HD': 'Home Depot Inc.', 'LOW': 'Lowe\'s Cos. Inc.', 
                'WMT': 'Walmart Inc.', 'TGT': 'Target Corp.',
                'JPM': 'JPMorgan Chase & Co.', 'BAC': 'Bank of America Corp.', 
                'WFC': 'Wells Fargo & Co.', 'C': 'Citigroup Inc.', 
                'GS': 'Goldman Sachs Group Inc.', 'MS': 'Morgan Stanley',
                'JNJ': 'Johnson & Johnson', 'PFE': 'Pfizer Inc.', 
                'UNH': 'UnitedHealth Group Inc.', 'MRK': 'Merck & Co. Inc.', 
                'ABBV': 'AbbVie Inc.', 'LLY': 'Eli Lilly & Co.',
                'PG': 'Procter & Gamble Co.', 'KO': 'Coca-Cola Co.', 
                'PEP': 'PepsiCo Inc.', 'MCD': 'McDonald\'s Corp.', 
                'NKE': 'Nike Inc.', 'COST': 'Costco Wholesale Corp.',
                'XOM': 'Exxon Mobil Corp.', 'CVX': 'Chevron Corp.', 
                'SHEL': 'Shell plc', 'TTE': 'TotalEnergies SE', 'BP': 'BP plc',
                'V': 'Visa Inc.', 'NFLX': 'Netflix Inc.', 'AMZN': 'Amazon.com Inc.',
            };

            const filterCategories = {
                all: [...defaultSymbols],
                tech: ['AAPL', 'MSFT', 'GOOGL', 'NVDA', 'META', 'TSLA', 'AMD', 'INTC'],
                etf: ['SPY', 'QQQ', 'VOO', 'VTI', 'GLD', 'SLV'],
                toys: ['HAS', 'MAT'],
                home: ['HD', 'LOW', 'WMT', 'TGT'],
                finanzas: ['JPM', 'BAC', 'WFC', 'C', 'GS', 'MS'],
                salud: ['JNJ', 'PFE', 'UNH', 'MRK', 'ABBV', 'LLY'],
                consumo: ['PG', 'KO', 'PEP', 'MCD', 'NKE', 'COST'],
                energia: ['XOM', 'CVX', 'SHEL', 'TTE', 'BP']
            };

            const state = {
                authToken: null,
                username: null,
                cash: 0,
                portfolio: {}, 
                marketStocks: [],
                currentSymbols: [...defaultSymbols],
                nameMap: {...PreloadedNames},
                currentTrade: {},
                historicalDataCache: {},
                dailyProfitLoss: null,
                activeFilter: 'all', 
                triggers: {}, 
                isCheckingTriggers: false,
                totalPortfolioValue: 0, 
                currentShortExposure: 0,
                favorites: new Set(), // NUEVO: Conjunto para favoritos
                averagePrices: {} // NUEVO: Para guardar precio medio de compra
            };
            
            let isLoginMode = true; 
            let marketDataInterval = null;
            let leaderboardInterval = null;
            let triggerCheckInterval = null;
            let marketTimerInterval = null;
            
            const MARKET_DATA_UPDATE_INTERVAL_MS = 3000;
            const LEADERBOARD_UPDATE_INTERVAL_MS = 3000;
            const TRIGGER_CHECK_INTERVAL_MS = 30000;

            // Elements
            const globalLoadingOverlay = document.getElementById('global-loading-overlay');
            const authView = document.getElementById('auth-view');
            const mainAppView = document.getElementById('main-app-view');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authButtonText = document.getElementById('auth-button-text');
            const logoutButton = document.getElementById('logout-button');
            const historyButton = document.getElementById('history-button');
            const cashBalanceEl = document.getElementById('cash-balance');
            const totalValueEl = document.getElementById('total-value');
            const dailyProfitLossEl = document.getElementById('daily-profit-loss');
            const stockMarketListEl = document.getElementById('stock-market-list');
            const favoritesListEl = document.getElementById('favorites-list'); // NUEVO
            const portfolioListEl = document.getElementById('portfolio-list');
            const welcomeMessageEl = document.getElementById('welcome-message');
            const searchInputEl = document.getElementById('search-input');
            const notificationArea = document.getElementById('notification-area');
            const marketLoader = document.getElementById('market-loader');
            const leaderboardListEl = document.getElementById('leaderboard-list');
            const chartModal = document.getElementById('chart-modal');
            const chartModalTitleEl = document.getElementById('chart-modal-title');
            const closeChartModalButton = document.getElementById('close-chart-modal-button');
            const tradingviewContainer = document.getElementById('tradingview-container');
            const chartLoader = document.getElementById('chart-loader');
            const chartErrorMessage = document.getElementById('chart-error-message');
            const historyModal = document.getElementById('history-modal');
            const closeHistoryModalButton = document.getElementById('close-history-modal-button');
            const tradeHistoryListEl = document.getElementById('trade-history-list');
            const historyLoadingStatusEl = document.getElementById('history-loading-status');
            const dailySummaryTextEl = document.getElementById('daily-summary-text');
            const dailySummaryErrorEl = document.getElementById('daily-summary-error');
            const topGainersButton = document.getElementById('top-gainers-button');
            const topLosersButton = document.getElementById('top-losers-button');
            const canAffordButton = document.getElementById('can-afford-button');
            const aiRecommendationsButton = document.getElementById('ai-recommendations-button');
            const filterContainer = document.getElementById('filter-container');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const tabMarket = document.getElementById('tab-market');
            const tabFavorites = document.getElementById('tab-favorites'); // NUEVO
            const tabTriggers = document.getElementById('tab-triggers');
            const marketContent = document.getElementById('market-content');
            const favoritesContent = document.getElementById('favorites-content'); // NUEVO
            const triggersContent = document.getElementById('triggers-content');
            const createTriggerForm = document.getElementById('create-trigger-form');
            const triggerSymbolEl = document.getElementById('trigger-symbol');
            const triggerQuantityEl = document.getElementById('trigger-quantity');
            const triggerActionEl = document.getElementById('trigger-action');
            const executionTypeEl = document.getElementById('execution-type');
            const priceConditionsEl = document.getElementById('price-conditions');
            const timeConditionsEl = document.getElementById('time-conditions');
            const triggerConditionEl = document.getElementById('trigger-condition');
            const triggerPriceEl = document.getElementById('trigger-price');
            const triggerDateEl = document.getElementById('trigger-date');
            const triggerTimeEl = document.getElementById('trigger-time');
            const triggerSubmitButton = document.getElementById('trigger-submit-button');
            const activeTriggersListEl = document.getElementById('active-triggers-list');
            const modal = document.getElementById('trade-modal');
            const modalTitleEl = document.getElementById('modal-title');
            const sharesInputEl = document.getElementById('shares-input');
            const modalTotalCostEl = document.getElementById('modal-total-cost');
            const modalCashRemainingEl = document.getElementById('modal-cash-remaining');
            const cashRemainingLabel = document.getElementById('cash-remaining-label');
            const cancelButtonEl = document.getElementById('cancel-button');
            const confirmButtonEl = document.getElementById('confirm-button');
            const timerStatusEl = document.getElementById('timer-status');
            const timerDisplayEl = document.getElementById('timer-display');

            function showLoader() { marketLoader.classList.remove('hidden'); }
            function hideLoader() { marketLoader.classList.add('hidden'); }
            function showGlobalLoader() { globalLoadingOverlay.classList.add('visible'); authView.classList.add('hidden'); }
            function hideGlobalLoader() { globalLoadingOverlay.classList.remove('visible'); }

            function setButtonLoading(buttonElement, originalText, isLoading, loadingText = 'Cargando...') {
                if (isLoading) {
                    buttonElement.dataset.originalText = originalText;
                    buttonElement.textContent = loadingText;
                    buttonElement.disabled = true;
                    buttonElement.style.opacity = '0.7';
                } else {
                    buttonElement.textContent = buttonElement.dataset.originalText || originalText;
                    buttonElement.disabled = false;
                    buttonElement.style.opacity = '1';
                }
            }

            // --- FAVORITES LOGIC ---
            function loadFavorites() {
                const saved = localStorage.getItem('tradeator_favorites');
                if (saved) {
                    try {
                        state.favorites = new Set(JSON.parse(saved));
                    } catch(e) { console.error("Error loading favorites", e); }
                }
            }

            function saveFavorites() {
                localStorage.setItem('tradeator_favorites', JSON.stringify([...state.favorites]));
            }

            function toggleFavorite(symbol) {
                if (state.favorites.has(symbol)) {
                    state.favorites.delete(symbol);
                    showNotification(`${symbol} eliminado de favoritos`);
                } else {
                    state.favorites.add(symbol);
                    showNotification(`${symbol} a침adido a favoritos`);
                }
                saveFavorites();
                renderMarket();
                renderFavorites();
            }

            function renderFavorites() {
                favoritesListEl.innerHTML = '';
                const favSymbols = Array.from(state.favorites);
                
                if (favSymbols.length === 0) {
                    favoritesListEl.innerHTML = '<p class="text-gray-400 text-center">No tienes acciones favoritas. Marca la estrella en el mercado para a침adir.</p>';
                    return;
                }

                // Reutilizamos la l칩gica de renderizado pero filtramos por favoritos
                // Asegurarnos que tenemos datos para estos s칤mbolos
                const favStocks = state.marketStocks.filter(s => state.favorites.has(s.symbol));
                
                if (favStocks.length === 0) {
                    // Si no est치n en marketStocks (ej. no cargados en 'all'), los pedimos o mostramos loading
                    // Para simplificar, mostraremos los que est칠n disponibles o texto de aviso
                    favoritesListEl.innerHTML = '<p class="text-gray-400 text-center">Cargando datos de favoritos...</p>';
                    return;
                }

                favStocks.forEach(stock => {
                    favoritesListEl.appendChild(createStockElement(stock));
                });
            }

            // --- INITIALIZATION SEQUENCE ---
            async function startAppLoadingSequence() {
                try {
                    await initializeMainApp();
                    hideGlobalLoader();
                    authView.classList.add('hidden'); 
                    mainAppView.classList.remove('hidden');
                    mainAppView.style.opacity = '1';
                } catch (error) {
                    hideGlobalLoader(); 
                    showNotification(`Error al cargar: ${error.message}`, 'error');
                    logoutForce();
                }
            }

            function logoutForce() {
                localStorage.removeItem('stock_simulator_token');
                localStorage.removeItem('stock_simulator_username');
                state.authToken = null;
                state.username = null;
                authView.classList.remove('hidden'); 
                authView.style.opacity = '1';
            }

            async function checkForSavedSession() {
                loadFavorites(); // Cargar favoritos al inicio
                const savedUsername = localStorage.getItem('stock_simulator_username');
                const savedPassword = localStorage.getItem('stock_simulator_password');
                if (savedUsername && savedPassword) {
                    try {
                        showGlobalLoader();
                        const response = await fetch(`${API_BASE_URL}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: savedUsername, password: savedPassword }),
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'Error');
                        state.authToken = data.token;
                        state.username = savedUsername;
                        showNotification(`Bienvenido de nuevo, ${savedUsername}`, 'info');
                        await startAppLoadingSequence();
                    } catch (error) {
                        hideGlobalLoader();
                        logoutForce();
                    }
                } else {
                    hideGlobalLoader();
                    authView.classList.remove('hidden');
                    mainAppView.classList.add('hidden');
                }
            }

            function toggleAuthMode(e) { if(e) e.preventDefault(); isLoginMode = !isLoginMode; authTitle.textContent = isLoginMode ? 'Iniciar Sesi칩n' : 'Crear Cuenta'; authButtonText.textContent = isLoginMode ? 'Iniciar Sesi칩n' : 'Crear Cuenta'; toggleAuthModeLink.textContent = isLoginMode ? 'crea una cuenta nueva' : 'inicia sesi칩n con una cuenta existente'; }

            async function handleAuthSubmit(e) {
                e.preventDefault();
                const username = authForm.username.value;
                const password = authForm.password.value;
                const endpoint = isLoginMode ? '/login' : '/signup';
                const originalButtonText = authSubmitButton.textContent;
                
                if (!isLoginMode) {
                    const lastSignup = localStorage.getItem(SIGNUP_COOLDOWN_KEY);
                    if (lastSignup && (Date.now() - parseInt(lastSignup)) < ONE_DAY_MS) {
                        showNotification('Solo una cuenta por d칤a.', 'error'); return;
                    }
                }
                setButtonLoading(authSubmitButton, originalButtonText, true);
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password }), });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error');
                    if (isLoginMode) {
                        state.authToken = data.token;
                        state.username = username;
                        localStorage.setItem('stock_simulator_username', username);
                        localStorage.setItem('stock_simulator_password', password);
                        showGlobalLoader();
                        await startAppLoadingSequence();
                    } else {
                        localStorage.setItem(SIGNUP_COOLDOWN_KEY, Date.now().toString());
                        showNotification('Cuenta creada. Inicia sesi칩n.', 'success');
                        toggleAuthMode();
                    }
                } catch (error) {
                    showNotification(error.message, 'error');
                } finally {
                    setButtonLoading(authSubmitButton, originalButtonText, false);
                }
            }

            function handleLogout() {
                clearInterval(marketDataInterval); clearInterval(leaderboardInterval); clearInterval(triggerCheckInterval); clearInterval(marketTimerInterval);
                localStorage.removeItem('stock_simulator_username'); localStorage.removeItem('stock_simulator_password');
                state.authToken = null; state.username = null; state.portfolio = {}; state.cash = 0; 
                state.favorites.clear();
                mainAppView.style.opacity = '0';
                setTimeout(() => { mainAppView.classList.add('hidden'); authView.classList.remove('hidden'); authView.style.opacity = '1'; }, 500);
            }

            async function authedFetch(endpoint, options = {}) {
                const headers = { ...options.headers, 'Authorization': `Bearer ${state.authToken}`, 'Content-Type': 'application/json', };
                const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                if (!response.ok) {
                    let errorData = {}; try { errorData = await response.json(); } catch {}
                    throw new Error(errorData.error || errorData.message || `Error en ${endpoint}`);
                }
                return response.json();
            }

            async function initializeMainApp() {
                welcomeMessageEl.textContent = `Bienvenido, ${state.username}`;
                updateFilterButtons(); 
                await fetchUserMoney();
                await fetchUserPortfolio();
                await fetchMyTriggers();
                
                // NUEVO: Calcular precios medios antes de cargar mercado para mostrar P&L total correcto
                await calculateAverageBuyPrices();

                await fetchHistoricalDataAndInitialMarket(); 

                if (marketDataInterval) clearInterval(marketDataInterval);
                if (leaderboardInterval) clearInterval(leaderboardInterval);
                if (triggerCheckInterval) clearInterval(triggerCheckInterval); 
                if (marketTimerInterval) clearInterval(marketTimerInterval); 

                marketDataInterval = setInterval(updateLiveMarketData, MARKET_DATA_UPDATE_INTERVAL_MS);
                leaderboardInterval = setInterval(fetchLeaderboardData, LEADERBOARD_UPDATE_INTERVAL_MS);
                triggerCheckInterval = setInterval(checkAllUserTriggers, TRIGGER_CHECK_INTERVAL_MS);
                marketTimerInterval = setInterval(updateMarketTimerDisplay, 1000); 

                updateMarketTimerDisplay();
                fetchLeaderboardData();
                fetchDailySummary();
            }

            // --- LOGIC PARA CALCULAR PRECIO MEDIO (TOTAL P&L) ---
            async function calculateAverageBuyPrices() {
                try {
                    const data = await authedFetch('/tradehistory'); 
                    const tradesArray = Object.values(data).sort((a, b) => a.time - b.time); // Ordenar cronol칩gicamente (antiguo -> nuevo)
                    
                    const tempPortfolio = {}; // { symbol: { quantity: 0, totalCost: 0 } }

                    tradesArray.forEach(trade => {
                        const sym = trade.symbol;
                        if (!tempPortfolio[sym]) tempPortfolio[sym] = { quantity: 0, totalCost: 0 };
                        
                        const qty = trade.quantity;
                        const price = trade.price;

                        if (trade.action === 'buy') {
                            tempPortfolio[sym].totalCost += (qty * price);
                            tempPortfolio[sym].quantity += qty;
                        } else if (trade.action === 'sell') {
                            // Cuando vendes, reduces cantidad y coste proporcionalmente (FIFO/Promedio simple)
                            // Evitar divisi칩n por cero
                            if (tempPortfolio[sym].quantity > 0) {
                                const avgPrice = tempPortfolio[sym].totalCost / tempPortfolio[sym].quantity;
                                tempPortfolio[sym].totalCost -= (qty * avgPrice);
                                tempPortfolio[sym].quantity -= qty;
                            }
                        }
                    });

                    // Guardar precios medios en el estado
                    state.averagePrices = {};
                    for (const sym in tempPortfolio) {
                        if (tempPortfolio[sym].quantity > 0) {
                            state.averagePrices[sym] = tempPortfolio[sym].totalCost / tempPortfolio[sym].quantity;
                        }
                    }

                } catch (error) {
                    console.error("Error calculando precio medio:", error);
                }
            }

            async function fetchUserMoney() {
                try { const data = await authedFetch('/money'); state.cash = data.cash; cashBalanceEl.textContent = `$${state.cash.toFixed(2)}`; } catch (error) {}
            }

            async function fetchUserPortfolio() {
                try { state.portfolio = await authedFetch('/trades') || {}; } catch (error) { state.portfolio = {}; }
            }
            
            // --- FIXED: LOCAL DAILY P&L CALCULATION ---
            function calculateLocalDailyProfitLoss() {
                let totalDailyPL = 0;
                let totalInvested = 0;

                for (const symbol in state.portfolio) {
                    const qty = state.portfolio[symbol];
                    const stock = state.marketStocks.find(s => s.symbol === symbol);
                    
                    if (stock && stock.change !== undefined) {
                        // Daily Change * Quantity
                        totalDailyPL += (stock.change * qty);
                        totalInvested += (stock.price * qty);
                    }
                }
                
                // Display
                const plClass = totalDailyPL >= 0 ? 'profit' : 'loss';
                const plSign = totalDailyPL >= 0 ? '+' : '';
                
                // Porcentaje respecto al valor total de acciones (aprox)
                const percent = totalInvested > 0 ? (totalDailyPL / totalInvested) * 100 : 0;

                dailyProfitLossEl.innerHTML = `
                    <p class="font-semibold ${plClass}">
                        BP Diario: ${plSign}${totalDailyPL.toFixed(2)}$ (${plSign}${percent.toFixed(2)}%)
                    </p>
                `;
            }

            function updateTotalValue() {
                let portfolioValue = 0;
                let currentShortExposure = 0; 

                for (const symbol in state.portfolio) {
                    const quantity = state.portfolio[symbol];
                    const stockData = state.marketStocks.find(s => s.symbol === symbol);
                    if (stockData) {
                        const marketValue = stockData.price * quantity;
                        portfolioValue += marketValue;
                        if (quantity < 0) currentShortExposure += Math.abs(marketValue);
                    }
                }
                const totalValue = state.cash + portfolioValue;
                totalValueEl.textContent = `$${totalValue.toFixed(2)}`;
                state.totalPortfolioValue = totalValue;
                state.currentShortExposure = currentShortExposure; 
                document.title = `$${totalValue.toFixed(2)} | Tradeator`;
                
                // Llamar al c치lculo local de BP diario aqu칤 para que se actualice al un칤sono
                calculateLocalDailyProfitLoss();
            }
            
            function calculateMarketTime() {
                const nowNY = new Date(new Date().toLocaleString("en-US", { timeZone: "America/New_York" }));
                const currentDay = nowNY.getDay(); 
                const NASDAQ_OPEN_HOUR = 9; const NASDAQ_OPEN_MINUTE = 30; const NASDAQ_CLOSE_HOUR = 16; 
                let nextOpen = new Date(nowNY); let nextClose = new Date(nowNY);
                nextOpen.setHours(NASDAQ_OPEN_HOUR, NASDAQ_OPEN_MINUTE, 0, 0);
                nextClose.setHours(NASDAQ_CLOSE_HOUR, 0, 0, 0);

                let statusText = 'Cerrado'; let targetTime = null;

                if (currentDay === 0 || currentDay === 6) {
                    nextOpen.setDate(nextOpen.getDate() + (currentDay === 0 ? 1 : 2));
                    statusText = 'Apertura del NASDAQ'; targetTime = nextOpen;
                } else {
                    const nowMinutes = nowNY.getHours() * 60 + nowNY.getMinutes();
                    const openMinutes = NASDAQ_OPEN_HOUR * 60 + NASDAQ_OPEN_MINUTE;
                    const closeMinutes = NASDAQ_CLOSE_HOUR * 60;

                    if (nowMinutes < openMinutes) { statusText = 'Apertura del NASDAQ'; targetTime = nextOpen; } 
                    else if (nowMinutes >= openMinutes && nowMinutes < closeMinutes) { statusText = 'Cierre del NASDAQ'; targetTime = nextClose; } 
                    else {
                        statusText = 'Apertura del NASDAQ';
                        nextOpen.setDate(nextOpen.getDate() + (currentDay === 5 ? 3 : 1));
                        nextOpen.setHours(NASDAQ_OPEN_HOUR, NASDAQ_OPEN_MINUTE, 0, 0);
                        targetTime = nextOpen;
                    }
                }
                const remainingMs = targetTime ? targetTime.getTime() - nowNY.getTime() : 0;
                const totalSeconds = Math.max(0, Math.floor(remainingMs / 1000));
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return { statusText, remainingTimeHms: `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}` };
            }

            function updateMarketTimerDisplay() {
                const { statusText, remainingTimeHms } = calculateMarketTime();
                timerStatusEl.textContent = statusText;
                timerDisplayEl.innerHTML = `<span class="text-orange-500">${remainingTimeHms}</span>`;
            }

            async function fetchMyTriggers() {
                try {
                    const data = await authedFetch('/triggers', { method: 'GET' });
                    state.triggers = data || {};
                    renderTriggers();
                } catch (error) { state.triggers = {}; }
            }

            function renderTriggers() {
                activeTriggersListEl.innerHTML = '';
                if (Object.keys(state.triggers).length === 0) {
                    activeTriggersListEl.innerHTML = `<p class="text-gray-400">No tienes programaciones activas.</p>`;
                    return;
                }
                for (const triggerId in state.triggers) {
                    const trigger = state.triggers[triggerId];
                    let conditionText = '', conditionColor = '', details = '';
                    const actionText = trigger.action === 'sell' ? 'Vender' : 'Comprar';
                    const actionColor = trigger.action === 'sell' ? 'text-red-400' : 'text-green-400';

                    if (trigger.executionType === 'price') {
                        conditionText = trigger.condition === 'lt' ? 'baja a menos de' : 'sube a m치s de';
                        conditionColor = trigger.condition === 'lt' ? 'text-red-400' : 'text-green-400';
                        details = `Si Precio <span class="${conditionColor}">${conditionText} $${trigger.targetPrice.toFixed(2)}</span>`;
                    } else {
                        conditionText = 'programada para'; conditionColor = 'text-blue-400';
                        details = `Ejecuci칩n <span class="${conditionColor}">${conditionText} ${trigger.date} a las ${trigger.time}</span>`;
                    }
                    const el = document.createElement('div');
                    el.className = 'bg-gray-900 p-3 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div><p class="font-semibold"><span class="${actionColor}">${actionText} ${trigger.quantity}</span> de ${trigger.symbol}</p><p class="text-sm text-gray-400">${details}</p></div>
                        <button data-trigger-id="${triggerId}" class="delete-trigger-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-md text-sm">Eliminar</button>`;
                    activeTriggersListEl.appendChild(el);
                }
            }

            function updateTriggerFormVisibility() {
                const type = executionTypeEl.value;
                priceConditionsEl.classList.toggle('hidden', type !== 'price');
                timeConditionsEl.classList.toggle('hidden', type !== 'time');
                if (type === 'price') { triggerPriceEl.required = true; triggerDateEl.required = false; triggerTimeEl.required = false; } 
                else { triggerPriceEl.required = false; triggerDateEl.required = true; triggerTimeEl.required = true; }
            }

            async function handleCreateTrigger(e) {
                e.preventDefault();
                const symbol = triggerSymbolEl.value.trim().toUpperCase();
                const quantity = parseInt(triggerQuantityEl.value);
                const action = triggerActionEl.value;
                const executionType = executionTypeEl.value;
                
                let payload = { symbol, quantity, executionType, action };
                if (executionType === 'price') {
                    payload.condition = triggerConditionEl.value; payload.targetPrice = parseFloat(triggerPriceEl.value);
                } else {
                    payload.date = triggerDateEl.value; payload.time = triggerTimeEl.value;
                }

                const originalButtonText = triggerSubmitButton.textContent;
                setButtonLoading(triggerSubmitButton, originalButtonText, true);
                try {
                    const result = await authedFetch('/triggers/add', { method: 'POST', body: JSON.stringify(payload) });
                    state.triggers = result.triggers;
                    renderTriggers();
                    showNotification('Programaci칩n creada.', 'success');
                    createTriggerForm.reset(); updateTriggerFormVisibility();
                } catch (error) { showNotification(error.message, 'error'); } finally { setButtonLoading(triggerSubmitButton, originalButtonText, false); }
            }

            async function handleDeleteTrigger(triggerId) {
                try {
                    const result = await authedFetch('/triggers/delete', { method: 'POST', body: JSON.stringify({ triggerId }) });
                    state.triggers = result.triggers;
                    renderTriggers();
                    showNotification('Eliminada.', 'info');
                } catch (error) { showNotification(error.message, 'error'); }
            }

            async function checkAllUserTriggers() {
                if (state.isCheckingTriggers) return;
                state.isCheckingTriggers = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/programs`);
                    const allTriggersData = await response.json();
                    const triggersToExecute = [];
                    const now = new Date();
                    
                    // Simplified check logic
                    for (const u in allTriggersData) {
                        for (const tid in allTriggersData[u]) {
                            const t = allTriggersData[u][tid];
                            // ... logic to check price/time ... (omitted for brevity, assumes similar logic to previous)
                            // Send to worker
                        }
                    }
                    // If execute:
                    // await sendTriggerToWorkerForExecution(t);
                    // await calculateAverageBuyPrices(); // Recalculate avg prices on trigger execute
                } catch(e) {}
                state.isCheckingTriggers = false;
            }

            async function fetchHistoricalDataAndInitialMarket() {
                showLoader();
                const combinedSymbols = new Set([...state.currentSymbols, ...Object.keys(state.portfolio), ...Object.values(state.triggers).map(t => t.symbol), ...state.favorites]);
                const symbolsForHistoryFetch = Array.from(combinedSymbols);
                
                if (symbolsForHistoryFetch.length > 0) {
                    try {
                        const historyRes = await fetch(`${API_BASE_URL}/history?symbol=${symbolsForHistoryFetch.join(',')}&days=10`);
                        if (historyRes.ok) {
                            const data = await historyRes.json();
                            state.historicalDataCache = data.results || {};
                            // Update nameMap logic
                        }
                    } catch (error) {}
                }
                
                const newMasterMarketStocks = []; // THIS IS THE VARIABLE
                const symbolsAlreadyProcessed = new Set();
                
                for (const symbol of combinedSymbols) {
                    if (symbolsAlreadyProcessed.has(symbol)) continue;
                    const hist = state.historicalDataCache[symbol];
                    let stockPrice, stockChange = 0, stockChangesPercentage = 0, stockHistory = [];
                    let stockName = state.nameMap[symbol] || symbol;

                    if (hist && hist['Time Series']) {
                        const historyEntries = Object.entries(hist['Time Series']).sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));
                        stockHistory = historyEntries.map(([, data]) => parseFloat(data['4. close']));
                        if (stockHistory.length >= 2) {
                            const latest = stockHistory[stockHistory.length - 1];
                            const prev = stockHistory[stockHistory.length - 2];
                            stockChange = latest - prev;
                            stockChangesPercentage = (prev !== 0) ? (stockChange / prev) * 100 : 0;
                            stockPrice = latest; // Default to hist close
                        }
                    }
                    // Live price override
                    const live = state.marketStocks.find(s => s.symbol === symbol)?.price;
                    if (live) stockPrice = live;

                    if (stockPrice) {
                        newMasterMarketStocks.push({ symbol, name: stockName, price: stockPrice, change: stockChange, changesPercentage: stockChangesPercentage, history: stockHistory });
                        symbolsAlreadyProcessed.add(symbol);
                    }
                }
                state.marketStocks = newMasterMarketStocks;
                hideLoader();
                await updateLiveMarketData();
            }

            async function updateLiveMarketData(externalLiveValues = {}) {
                const symbolsToRefresh = new Set();
                state.marketStocks.forEach(stock => symbolsToRefresh.add(stock.symbol)); 
                const symbolsString = Array.from(symbolsToRefresh).join(',');
                if (symbolsString.length === 0) { renderMarket(); renderFavorites(); renderPortfolio(); updateTotalValue(); return; }
                
                let liveValuesData = externalLiveValues;
                if (Object.keys(liveValuesData).length === 0) {
                     try {
                        const liveValuesRes = await fetch(`${API_LIVE_VALUES_URL}/${symbolsString}`);
                        if (liveValuesRes.ok) {
                            const data = await liveValuesRes.json();
                            liveValuesData = data.liveValues || {};
                        }
                    } catch (error) {}
                }
                state.marketStocks = state.marketStocks.map(stock => {
                    const livePrice = liveValuesData[stock.symbol];
                    if (livePrice !== undefined && livePrice !== null && !isNaN(livePrice)) {
                        const prevPrice = stock.price - stock.change; // Estimate prev
                        const newChange = livePrice - prevPrice;
                        const newChangePercent = (prevPrice !== 0) ? (newChange / prevPrice) * 100 : 0;
                        return { ...stock, price: livePrice, change: newChange, changesPercentage: newChangePercent };
                    }
                    return stock; 
                });
                renderMarket(); renderFavorites(); renderPortfolio(); updateTotalValue();
            }

            // --- CREAR ELEMENTO STOCK COM칔N (Para Mercado y Favoritos) ---
            function createStockElement(stock) {
                const { symbol, price, change, changesPercentage, history, name } = stock;
                const changeClass = change >= 0 ? 'stock-up' : 'stock-down';
                const changeSign = change >= 0 ? '+' : '';
                const isFav = state.favorites.has(symbol);
                const starClass = isFav ? 'active' : 'text-gray-600';

                const el = document.createElement('div');
                el.className = 'stock-item grid grid-cols-3 md:grid-cols-5 items-center bg-gray-900 p-4 rounded-lg hover:bg-gray-700/50';
                el.dataset.symbol = symbol;
                
                // Sparkline gen logic
                const width = 100, height = 30;
                let svg = '';
                if (history && history.length > 1) {
                    const max = Math.max(...history), min = Math.min(...history), range = max - min || 1;
                    const points = history.map((d, i) => `${(i/(history.length-1)*width).toFixed(2)},${(height-((d-min)/range)*height).toFixed(2)}`).join(' ');
                    svg = `<svg viewBox="0 0 ${width} ${height}" class="w-24 h-8" preserveAspectRatio="none"><polyline fill="none" stroke="${change >= 0 ? '#22C55E' : '#EF4444'}" stroke-width="1.5" points="${points}" /></svg>`;
                }

                el.innerHTML = `
                    <div class="col-span-2 md:col-span-2 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 star-icon ${starClass}" viewBox="0 0 20 20" fill="currentColor" data-symbol="${symbol}">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                        <div class="cursor-pointer stock-detail-trigger">
                            <p class="font-bold text-lg">${symbol}</p>
                            <p class="text-sm text-gray-400 truncate w-32">${name}</p>
                        </div>
                    </div>
                    <div class="hidden md:block pointer-events-none">${svg}</div>
                    <div class="text-right cursor-pointer stock-detail-trigger">
                        <p class="font-semibold text-lg">$${price.toFixed(2)}</p>
                        <p class="text-sm ${changeClass}">${changeSign}${change.toFixed(2)}$ (${changeSign}${changesPercentage.toFixed(2)}%)</p>
                    </div>
                    <div class="flex flex-col md:flex-row justify-end ml-2 space-y-1 md:space-y-0 md:space-x-1">
                        <button data-symbol="${symbol}" data-type="buy" class="trade-btn text-xs font-bold bg-green-600 hover:bg-green-500 text-white py-1 px-2 rounded-md">COMPRAR</button>
                        <button data-symbol="${symbol}" data-type="sell" class="trade-btn text-xs font-bold bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded-md">VENDER</button>
                    </div>`;
                return el;
            }

            function renderMarket() {
                stockMarketListEl.innerHTML = '';
                const stocksToDisplay = state.marketStocks.filter(stock => state.currentSymbols.includes(stock.symbol));
                if(stocksToDisplay.length === 0) { stockMarketListEl.innerHTML = `<p class="text-gray-400 text-center py-4">No se encontraron acciones.</p>`; return; }
                stocksToDisplay.forEach(stock => stockMarketListEl.appendChild(createStockElement(stock)));
            }

            function renderPortfolio() {
                portfolioListEl.innerHTML = '';
                if (Object.keys(state.portfolio).length === 0) { portfolioListEl.innerHTML = `<p class="text-gray-400">A칰n no tienes acciones.</p>`; return; }
                
                for (const symbol in state.portfolio) {
                    const quantity = state.portfolio[symbol];
                    if (quantity === 0) continue;
                    const stockData = state.marketStocks.find(s => s.symbol === symbol);
                    const currentValue = stockData ? stockData.price * quantity : 0;
                    const priceDisplay = stockData ? `@ ${stockData.price.toFixed(2)}` : 'Cargando...';

                    // --- NEW LOGIC: TOTAL P&L INSTEAD OF DAILY ---
                    let totalProfitLossHtml = '';
                    const avgPrice = state.averagePrices[symbol];
                    
                    if (stockData && avgPrice) {
                        // Calculate Total Gain/Loss: (Current - Avg) * Qty
                        // If short (qty < 0): (Avg - Current) * |Qty|
                        const diffPerShare = stockData.price - avgPrice;
                        let totalPlAmount, totalPlPercent;

                        if (quantity > 0) {
                            totalPlAmount = diffPerShare * quantity;
                            totalPlPercent = (diffPerShare / avgPrice) * 100;
                        } else {
                            // Short position: Profit if price goes down
                            totalPlAmount = (avgPrice - stockData.price) * Math.abs(quantity);
                            totalPlPercent = ((avgPrice - stockData.price) / avgPrice) * 100;
                        }

                        const plClass = totalPlAmount >= 0 ? 'profit' : 'loss';
                        const plSign = totalPlAmount >= 0 ? '+' : '';
                        
                        totalProfitLossHtml = `
                            <p class="text-sm ${plClass}">
                                Total: ${plSign}${totalPlAmount.toFixed(2)}$ (${plSign}${totalPlPercent.toFixed(2)}%)
                            </p>`;
                    } else if (stockData) {
                        totalProfitLossHtml = `<p class="text-xs text-gray-500">Calculando...</p>`;
                    }
                    // --------------------------------------------

                    const posType = quantity > 0 ? 'Long' : 'Short';
                    const posColor = quantity > 0 ? 'text-green-400' : 'text-red-400';
                    const absQuantity = Math.abs(quantity);

                    const el = document.createElement('div');
                    el.className = 'stock-item bg-gray-900 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50';
                    el.dataset.symbol = symbol; 
                    el.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg">${symbol}</p>
                                <p class="text-sm text-gray-400">${absQuantity} acc. (<span class="${posColor} font-semibold">${posType}</span>)</p>
                                <p class="text-xs text-gray-500">Media: $${avgPrice ? avgPrice.toFixed(2) : '?'}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-lg">$${currentValue.toFixed(2)}</p>
                                <p class="text-sm text-gray-500">${priceDisplay}</p>
                                ${totalProfitLossHtml}
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <button data-symbol="${symbol}" data-type="buy" class="trade-btn w-full text-xs font-bold bg-green-600 hover:bg-green-500 text-white py-1 px-2 rounded-md">${quantity < 0 ? 'CUBRIR' : 'COMPRAR'}</button>
                            <button data-symbol="${symbol}" data-type="sell" class="trade-btn w-full text-xs font-bold bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded-md">${quantity > 0 ? 'VENDER' : 'V. CORTO'}</button>
                        </div>`;
                    portfolioListEl.appendChild(el);
                }
            }

            async function fetchLeaderboardData() {
                try {
                    const data = await authedFetch(`/leaderboard?_t=${Date.now()}`);
                    if (data.leaderboard) renderLeaderboard(data.leaderboard);
                } catch (error) {}
            }

            function renderLeaderboard(leaderboardData) {
                leaderboardListEl.innerHTML = ''; 
                leaderboardData.forEach((user, index) => {
                    let liClasses = 'bg-gray-900 p-3 rounded-lg flex justify-between items-center';
                    if (index === 0) liClasses += ' leaderboard-first-place'; 
                    else if (user.username === state.username) liClasses += ' leaderboard-your-entry'; 
                    const el = document.createElement('div'); el.className = liClasses;
                    el.innerHTML = `<div><p class="font-bold text-md">${index + 1}. ${user.username}</p></div><div class="text-right"><p class="font-semibold text-md">$${user.totalPortfolioValue.toFixed(2)}</p></div>`;
                    leaderboardListEl.appendChild(el);
                });
            }

            async function fetchDailySummary() {
                try {
                    const response = await fetch(`${API_BASE_URL}/today`);
                    const data = await response.json();
                    if (data && data.dailySummary) { dailySummaryTextEl.textContent = data.dailySummary; dailySummaryTextEl.classList.remove('hidden'); }
                } catch (error) {}
            }
            
            function openTradeModal(e) {
                const { symbol, type } = e.target.dataset;
                state.currentTrade = { symbol, type };
                const stock = state.marketStocks.find(s => s.symbol === symbol);
                if(!stock) { showNotification(`Error datos ${symbol}.`, 'error'); return; }
                
                const currentHolding = state.portfolio[symbol] || 0;
                let actionText = type === 'buy' ? ((currentHolding < 0) ? `Cubrir Corto ${symbol}` : `Comprar ${symbol}`) : ((currentHolding > 0) ? `Vender ${symbol}` : `Vender en Corto ${symbol}`);
                modalTitleEl.textContent = actionText;
                confirmButtonEl.textContent = `Confirmar`;
                confirmButtonEl.className = `px-4 py-2 rounded-md font-semibold ${type === 'buy' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'}`;
                cashRemainingLabel.textContent = type === 'buy' ? 'Efectivo restante:' : 'Efectivo despu칠s:';
                sharesInputEl.value = '1';
                if (type === 'buy') sharesInputEl.max = Math.floor(state.cash / stock.price); else sharesInputEl.removeAttribute('max');
                updateTradeModalCalculations();
                modal.classList.remove('hidden'); modal.classList.add('flex');
            }

            function updateTradeModalCalculations() {
                const { symbol, type } = state.currentTrade;
                const stock = state.marketStocks.find(s => s.symbol === symbol);
                if (!stock) return;
                const shares = parseInt(sharesInputEl.value) || 0;
                const totalCost = shares * stock.price;
                modalTotalCostEl.textContent = `$${totalCost.toFixed(2)}`;
                let cashAfterTrade = type === 'buy' ? state.cash - totalCost : state.cash + totalCost;
                modalCashRemainingEl.textContent = `$${cashAfterTrade.toFixed(2)}`;
            }
            
            async function executeTrade() {
                const { symbol, type } = state.currentTrade;
                const quantity = parseInt(sharesInputEl.value);
                if(!quantity || quantity <= 0) { showNotification('Cantidad inv치lida', 'error'); return; }
                const stock = state.marketStocks.find(s => s.symbol === symbol);
                const tradeValue = quantity * stock.price;
                if (type === 'buy' && tradeValue > state.cash) { showNotification('Fondos insuficientes.', 'error'); return; }
                
                // Short Debt Check Logic here (omitted for brevity, same as previous)
                
                const originalConfirmText = confirmButtonEl.textContent;
                setButtonLoading(confirmButtonEl, originalConfirmText, true);

                try {
                    const endpoint = type === 'buy' ? '/trades/add' : '/trades/sell';
                    await authedFetch(endpoint, { method: 'POST', body: JSON.stringify({ symbol, quantity }) });
                    await Promise.all([fetchUserPortfolio(), fetchUserMoney(), calculateAverageBuyPrices()]); // Recalculate Avg Price
                    await updateLiveMarketData(); 
                    showNotification('Operaci칩n realizada', 'success');
                    closeTradeModal();
                } catch (error) { showNotification(error.message, 'error'); } finally { setButtonLoading(confirmButtonEl, originalConfirmText, false); }
            }

            function closeTradeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

            async function openChartModal(symbol) {
                chartModalTitleEl.textContent = `Gr치fico ${symbol}`; chartModal.classList.remove('hidden'); chartModal.classList.add('flex'); chartLoader.classList.remove('hidden'); chartErrorMessage.classList.add('hidden');
                tradingviewContainer.innerHTML = `<div class="tradingview-widget-container h-full w-full"><iframe src="https://s.tradingview.com/widgetembed/?symbol=NASDAQ%3A${symbol}&amp;interval=D&amp;hidesidetoolbar=0&amp;hidetoptoolbar=0&amp;saveimage=false&amp;toolbarbg=1F2937&amp;details=false&amp;studies=RSI%40tv-basiccharts%2FMACD%40tv-basiccharts&amp;theme=dark&amp;style=1&amp;timezone=America%2FNew_York&amp;studies_overrides={}&amp;utm_source=tradeator&amp;utm_medium=widget&amp;utm_campaign=chart&amp;utm_term=${symbol}" style="width: 100%; height: 100%;" allowfullscreen frameborder="0" loading="lazy"></iframe></div>`;
                chartLoader.classList.add('hidden');
            }

            function closeChartModal() { chartModal.classList.add('hidden'); chartModal.classList.remove('flex'); tradingviewContainer.innerHTML = ''; }
            
            async function openHistoryModal() {
                historyLoadingStatusEl.textContent = 'Cargando historial...'; tradeHistoryListEl.innerHTML = ''; historyModal.classList.remove('hidden'); historyModal.classList.add('flex');
                try {
                    const data = await authedFetch('/tradehistory'); const tradesArray = Object.values(data).sort((a, b) => b.time - a.time);
                    historyLoadingStatusEl.classList.add('hidden');
                    if (tradesArray.length === 0) tradeHistoryListEl.innerHTML = `<p class="text-gray-400 text-center py-4">Vac칤o.</p>`;
                    tradesArray.forEach(trade => {
                        const el = document.createElement('div');
                        el.className = `bg-gray-900 p-3 rounded-lg flex items-center shadow-md ${trade.action === 'buy' ? 'trade-row-buy' : 'trade-row-sell'}`;
                        el.innerHTML = `<div class="grid grid-cols-5 md:grid-cols-6 gap-2 w-full items-center text-sm"><div class="${trade.action === 'buy' ? 'text-green-400' : 'text-red-400'} font-bold">${trade.action.toUpperCase()}</div><div class="font-semibold">${trade.symbol}</div><div class="hidden md:block">${trade.quantity}</div><div>$${trade.price.toFixed(2)}</div><div class="text-yellow-400">${trade.source === 'manual' ? 'M' : 'Auto'}</div><div class="text-right">${new Date(trade.time).toLocaleDateString()}</div></div>`;
                        tradeHistoryListEl.appendChild(el);
                    });
                } catch (error) { showNotification('Error historial', 'error'); }
            }

            function closeHistoryModal() { historyModal.classList.add('hidden'); historyModal.classList.remove('flex'); }

            // --- SEARCH & FILTERS ---
            let debounceTimeout;
            async function handleSearch(e) {
                const query = e.target.value.trim();
                clearTimeout(debounceTimeout);
                if (query) { state.activeFilter = null; updateFilterButtons(); } else if (!query && state.activeFilter === null) { state.activeFilter = 'all'; updateFilterButtons(); }
                debounceTimeout = setTimeout(async () => {
                    if (!query) { state.currentSymbols = filterCategories[state.activeFilter] || [...defaultSymbols]; } 
                    else {
                        try { const results = await (await fetch(`${API_BASE_URL}/search/${query}`)).json(); if(results.length) { state.currentSymbols = results.map(i => i.symbol); results.forEach(i => state.nameMap[i.symbol] = i.name); } } catch {}
                    }
                    await fetchHistoricalDataAndInitialMarket();
                }, 500);
            }

            async function fetchTopStocks(endpoint, buttonElement) {
                const original = buttonElement.textContent; setButtonLoading(buttonElement, original, true);
                state.activeFilter = null; updateFilterButtons(); searchInputEl.value = '';
                try {
                    const data = await (await fetch(`${API_BASE_URL}${endpoint}`)).json();
                    if (data.length) {
                        state.currentSymbols = data.map(i => i.symbol); data.forEach(i => state.nameMap[i.symbol] = i.name);
                        // FIX: Renombrado para evitar el error 'newMasterMarketStocks is not defined'
                        const newMarketStocks = []; 
                        data.forEach(item => {
                            newMarketStocks.push({ symbol: item.symbol, name: item.name, price: item.price, change: item.change, changesPercentage: item.changePercent, history: [] });
                        });
                        // Aqu칤 deber칤amos fusionar, pero para simplificar llamamos a fetchHistorical para llenar datos correctos
                        await fetchHistoricalDataAndInitialMarket(); 
                    }
                } catch (e) { state.currentSymbols = [...defaultSymbols]; await fetchHistoricalDataAndInitialMarket(); } finally { setButtonLoading(buttonElement, original, false); }
            }
            
            function handleFilterClick(e) {
                const btn = e.target.closest('.filter-btn'); if (!btn) return; 
                state.activeFilter = btn.dataset.filter; state.currentSymbols = filterCategories[state.activeFilter] || [...defaultSymbols]; searchInputEl.value = ''; updateFilterButtons(); fetchHistoricalDataAndInitialMarket();
            }
            function updateFilterButtons() { filterButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.filter === state.activeFilter)); }

            // --- TAB SWITCHING ---
            function switchTab(tab) {
                tabMarket.classList.toggle('active', tab === 'market');
                tabFavorites.classList.toggle('active', tab === 'favorites');
                tabTriggers.classList.toggle('active', tab === 'triggers');
                marketContent.classList.toggle('hidden', tab !== 'market');
                favoritesContent.classList.toggle('hidden', tab !== 'favorites');
                triggersContent.classList.toggle('hidden', tab !== 'triggers');
                if (tab === 'favorites') renderFavorites();
            }

            function showNotification(message, type = 'info') {
                const el = document.createElement('div'); el.className = `notification ${type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2`;
                el.textContent = message; notificationArea.appendChild(el);
                setTimeout(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; }, 10);
                setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 4000);
            }

            // --- EVENT LISTENERS ---
            toggleAuthModeLink.addEventListener('click', toggleAuthMode);
            authForm.addEventListener('submit', handleAuthSubmit);
            logoutButton.addEventListener('click', handleLogout);
            historyButton.addEventListener('click', openHistoryModal);
            closeHistoryModalButton.addEventListener('click', closeHistoryModal);
            historyModal.querySelector('.modal-backdrop').addEventListener('click', closeHistoryModal);
            
            searchInputEl.addEventListener('input', handleSearch);
            topGainersButton.addEventListener('click', () => fetchTopStocks('/searchhighs', topGainersButton));
            topLosersButton.addEventListener('click', () => fetchTopStocks('/searchlows', topLosersButton));
            canAffordButton.addEventListener('click', () => fetchTopStocks(`/canafford/${state.cash}`, canAffordButton));
            aiRecommendationsButton.addEventListener('click', () => fetchTopStocks('/ai', aiRecommendationsButton));
            filterContainer.addEventListener('click', handleFilterClick);

            tabMarket.addEventListener('click', () => switchTab('market'));
            tabFavorites.addEventListener('click', () => switchTab('favorites'));
            tabTriggers.addEventListener('click', () => switchTab('triggers'));
            
            executionTypeEl.addEventListener('change', updateTriggerFormVisibility);
            createTriggerForm.addEventListener('submit', handleCreateTrigger);
            activeTriggersListEl.addEventListener('click', e => { if (e.target.closest('.delete-trigger-btn')) handleDeleteTrigger(e.target.closest('.delete-trigger-btn').dataset.triggerId); });

            // Market & Favorites Click Handling
            const handleStockClick = e => {
                if (e.target.closest('.star-icon')) { toggleFavorite(e.target.closest('.star-icon').dataset.symbol); }
                else if (e.target.closest('.trade-btn')) { openTradeModal(e); }
                else if (e.target.closest('.stock-detail-trigger')) { 
                    const item = e.target.closest('.stock-item'); 
                    if (item) openChartModal(item.dataset.symbol); 
                }
            };
            stockMarketListEl.addEventListener('click', handleStockClick);
            favoritesListEl.addEventListener('click', handleStockClick);

            portfolioListEl.addEventListener('click', e => {
                if (e.target.closest('.trade-btn')) openTradeModal(e);
                else { const item = e.target.closest('.stock-item'); if (item) openChartModal(item.dataset.symbol); }
            });
            
            cancelButtonEl.addEventListener('click', closeTradeModal);
            confirmButtonEl.addEventListener('click', executeTrade);
            sharesInputEl.addEventListener('input', updateTradeModalCalculations);
            closeChartModalButton.addEventListener('click', closeChartModal);
            chartModal.querySelector('.modal-backdrop').addEventListener('click', closeChartModal);

            checkForSavedSession(); 
            authButtonText.textContent = isLoginMode ? 'Iniciar Sesi칩n' : 'Crear Cuenta';
            updateTriggerFormVisibility();
        });
    </script>
</body>
</html>