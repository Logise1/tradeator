<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tradeator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Web App Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#111827"> 

    <!-- Iconos -->
    <link rel="icon" type="image/png" sizes="192x192" href="https://weberia.neocities.org/stock.png" purpose="any maskable">
    <link rel="icon" type="image/png" sizes="512x512" href="https://weberia.neocities.org/stock.png" purpose="any maskable">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tradeator">
    <link rel="apple-touch-icon" href="https://weberia.neocities.org/stock.png">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #F9FAFB;
        }
        .stock-up { color: #22C55E; }
        .stock-down { color: #EF4444; }
        .profit { color: #22C55E; }
        .loss { color: #EF4444; }
        .favorite-active { color: #FBBF24; /* Amber-400 */ }
        .favorite-inactive { color: #4B5563; /* Gray-600 */ }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); }
        .loader {
            border: 4px solid #4B5563;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #auth-view, #main-app-view { transition: opacity 0.5s ease-in-out; }
        .notification { transition: opacity 0.5s, transform 0.5s; }

        .leaderboard-first-place {
            background-color: #FFD700 !important; 
            color: #000000 !important; 
            font-weight: bold;
        }
        .leaderboard-your-entry {
            background-color: #FFFF00 !important; 
            color: #000000 !important; 
        }

        #global-loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.3s ease-in-out; opacity: 0; visibility: hidden;
        }
        #global-loading-overlay.visible { opacity: 1; visibility: visible; }

        .chart-loader {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        
        .filter-btn {
            background-color: #374151; color: #D1D5DB; transition: background-color 0.2s, color 0.2s;
        }
        .filter-btn:hover { background-color: #4B5563; }
        .filter-btn.active {
            background-color: #3B82F6; color: #FFFFFF; font-weight: 600;
        }

        .tab-btn {
            background-color: transparent; color: #9CA3AF; border-bottom: 2px solid transparent;
            transition: color 0.2s, border-color 0.2s;
        }
        .tab-btn:hover { color: #D1D5DB; }
        .tab-btn.active {
            color: #3B82F6; border-bottom-color: #3B82F6; font-weight: 600;
        }

        .trade-row-buy { border-left: 4px solid #22C55E; }
        .trade-row-sell { border-left: 4px solid #EF4444; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- Global Loading Overlay -->
    <div id="global-loading-overlay">
        <div class="loader"></div>
        <p class="text-white text-lg mt-4">Cargando...</p>
    </div>

    <!-- Authentication View -->
    <div id="auth-view" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md p-8 space-y-8 bg-gray-800 rounded-lg shadow-lg">
            <div>
                <h2 id="auth-title" class="text-center text-3xl font-extrabold text-white">Tradeator</h2>
                <p class="mt-2 text-center text-sm text-gray-400">
                    O <a href="#" id="toggle-auth-mode" class="font-medium text-blue-400 hover:text-blue-300">crea una cuenta nueva</a>
                </p>
            </div>
            <form id="auth-form" class="space-y-6">
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Usuario</label>
                        <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-gray-200 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Usuario">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Contrase침a</label>
                        <input id="password" name="password" type="password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-700 bg-gray-900 placeholder-gray-500 text-gray-200 rounded-b-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500" placeholder="Contrase침a">
                    </div>
                </div>
                <div>
                    <button type="submit" id="auth-submit-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500">
                        <span id="auth-button-text">Iniciar Sesi칩n</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App View -->
    <div id="main-app-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">Tradeator</h1>
                    <p id="welcome-message" class="text-gray-400">Bienvenido, ...</p>
                </div>
                <div class="flex items-center space-x-4 mt-4 md:mt-0">
                    <!-- Timer -->
                    <div class="w-48 text-center bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h2 id="timer-status" class="text-lg font-semibold text-gray-400">游 Nasdaq: Cargando...</h2>
                        <p id="timer-display" class="text-4xl font-bold text-orange-500 mt-1">--</p>
                    </div>
                    <!-- Total Value & Daily P/L -->
                    <div class="w-48 text-center bg-gray-800 p-4 rounded-lg shadow-lg">
                        <h2 class="text-lg font-semibold text-gray-400">Valor Portafolio</h2>
                        <p id="total-value" class="text-3xl font-bold text-white">$0.00</p>
                        <div id="daily-profit-loss" class="mt-2 text-sm">
                            <!-- Daily P&L Rendered Here -->
                        </div>
                    </div>
                    
                    <button id="history-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Historial
                    </button>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                        Salir
                    </button>
                </div>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 bg-gray-800/50 rounded-lg p-6 shadow-2xl">
                    <!-- Tabs -->
                    <div class="flex space-x-4 border-b border-gray-700 mb-4">
                        <button id="tab-market" class="tab-btn py-2 px-4 text-lg active">Mercado</button>
                        <button id="tab-favorites" class="tab-btn py-2 px-4 text-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                            </svg>
                            Favoritos
                        </button>
                        <button id="tab-triggers" class="tab-btn py-2 px-4 text-lg">Programaciones</button>
                    </div>

                    <!-- Market Content -->
                    <div id="market-content">
                        <div class="flex justify-between items-center pb-2 mb-4">
                            <h2 id="market-heading" class="text-2xl font-bold">Mercado de Acciones</h2>
                            <div id="api-status" class="flex items-center space-x-2">
                                <div id="market-loader" class="loader hidden"></div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="search-input" placeholder="Buscar s칤mbolo (ej. AAPL)..." class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                        
                        <!-- Filters -->
                        <div id="filter-container" class="flex flex-wrap gap-2 mb-4">
                            <button class="filter-btn active py-2 px-4 rounded-md text-sm font-medium" data-filter="all">Todos</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="tech">Tecnolog칤a</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="etf">ETFs</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="home">Hogar</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="finanzas">Finanzas</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="salud">Salud</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="consumo">Consumo</button>
                            <button class="filter-btn py-2 px-4 rounded-md text-sm font-medium" data-filter="energia">Energ칤a</button>
                        </div>

                        <!-- Quick Action Buttons -->
                        <div class="flex justify-between space-x-2 mb-4">
                            <button id="top-gainers-button" class="w-1/3 bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition-colors">游릭拘勇</button>
                            <button id="top-losers-button" class="w-1/3 bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">游댮拘勇</button>
                            <button id="can-afford-button" class="w-1/3 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition-colors">Al alcance</button>
                            <button id="ai-recommendations-button" class="w-1/4 bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-xs md:text-sm">九IA</button>
                        </div>

                        <!-- Daily Summary -->
                        <div id="daily-summary-section" class="bg-gray-700/50 p-4 rounded-lg mb-4">
                            <h3 class="text-xl font-bold text-white mb-2">Resumen Diario de la Bolsa</h3>
                            <p id="daily-summary-text" class="text-gray-300">Cargando resumen...</p>
                            <p id="daily-summary-error" class="text-red-400 hidden">Error al cargar el resumen diario.</p>
                        </div>
                        <div id="stock-market-list" class="space-y-4 max-h-[55vh] overflow-y-auto pr-2"></div>
                    </div>

                    <!-- Triggers Content -->
                    <div id="triggers-content" class="hidden">
                        <h2 class="text-2xl font-bold mb-4">Programar Operaciones</h2>
                        <form id="create-trigger-form" class="bg-gray-900 p-4 rounded-lg mb-6 space-y-3">
                            <h3 class="text-xl font-semibold text-white">Crear Nueva Programaci칩n</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">S칤mbolo</label>
                                    <input type="text" id="trigger-symbol" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="NVDA">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Cantidad</label>
                                    <input type="number" id="trigger-quantity" min="1" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="10">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Acci칩n</label>
                                    <select id="trigger-action" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                                        <option value="sell">Vender</option>
                                        <option value="buy">Comprar</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Tipo</label>
                                    <select id="execution-type" required class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                                        <option value="price">Precio</option>
                                        <option value="time">Tiempo</option>
                                    </select>
                                </div>
                            </div>
                            <div id="price-conditions" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Condici칩n</label>
                                    <select id="trigger-condition" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                                        <option value="lt">Baja a &lt;</option>
                                        <option value="gt">Sube a &gt;</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Precio Objetivo</label>
                                    <input type="number" id="trigger-price" step="0.01" min="0" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white" placeholder="150.00">
                                </div>
                            </div>
                            <div id="time-conditions" class="grid grid-cols-1 md:grid-cols-2 gap-3 hidden">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Fecha</label>
                                    <input type="date" id="trigger-date" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-1">Hora (CET)</label>
                                    <input type="time" id="trigger-time" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white">
                                </div>
                            </div>
                            <button type="submit" id="trigger-submit-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Crear Programaci칩n</button>
                        </form>
                        <div id="active-triggers-list" class="space-y-3 max-h-[40vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="bg-gray-800/50 rounded-lg p-6 shadow-2xl">
                    <div class="mb-6">
                        <h3 class="text-xl font-bold text-white mb-2">Efectivo Disponible</h3>
                        <p id="cash-balance" class="text-2xl font-semibold text-green-400">$0.00</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Tu Portafolio</h3>
                        <div id="portfolio-list" class="space-y-4 max-h-[30vh] overflow-y-auto pr-2"></div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-white mb-2 border-b border-gray-700 pb-2">Clasificaci칩n Global</h3>
                        <div id="leaderboard-list" class="space-y-4 max-h-[25vh] overflow-y-auto pr-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="trade-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 max-w-lg z-10">
            <h2 id="modal-title" class="text-2xl font-bold mb-4"></h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-300 mb-1">Cantidad:</label>
                <input type="number" id="shares-input" min="1" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="mb-4">
                <p class="text-gray-400">Total: <span id="modal-total-cost" class="font-bold text-white">$0.00</span></p>
                <p id="cash-remaining-label" class="text-gray-400">Efectivo restante: <span id="modal-cash-remaining" class="font-bold text-white">$0.00</span></p>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-button" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md">Cancelar</button>
                <button id="confirm-button" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md"></button>
            </div>
        </div>
    </div>

    <div id="chart-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 md:w-1/2 max-w-2xl z-10">
            <div class="flex justify-between items-center mb-4">
                <h2 id="chart-modal-title" class="text-2xl font-bold text-white"></h2>
                <button id="close-chart-modal-button" class="text-gray-400 hover:text-white text-xl font-bold">&times;</button>
            </div>
            <div id="chart-loader" class="chart-loader hidden"></div>
            <div id="tradingview-container" class="relative w-full h-[50vh] min-h-[300px] overflow-hidden"></div>
            <p id="chart-error-message" class="text-red-400 text-center mt-4 hidden">Error al cargar gr치fico.</p>
        </div>
    </div>

    <div id="history-modal" class="fixed inset-0 z-50 items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0"></div>
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-w-3xl z-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Historial</h2>
                <button id="close-history-modal-button" class="text-gray-400 hover:text-white text-xl font-bold">&times;</button>
            </div>
            <div class="bg-gray-900 p-3 rounded-t-lg grid grid-cols-5 md:grid-cols-6 gap-2 font-semibold border-b border-gray-700 sticky top-0">
                <div class="col-span-1">Acci칩n</div>
                <div class="col-span-1">S칤mbolo</div>
                <div class="hidden md:block">Cantidad</div>
                <div class="col-span-1">Precio</div>
                <div class="col-span-1">Fuente</div>
                <div class="col-span-1 text-right">Tiempo</div>
            </div>
            <div id="trade-history-list" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                <p id="history-loading-status" class="text-gray-400 text-center py-4">Cargando...</p>
            </div>
        </div>
    </div>

    <div id="notification-area" class="fixed bottom-5 right-5 space-y-2 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'https://finances.logise1123.workers.dev';
            const API_LIVE_VALUES_URL = 'https://finances.logise1123.workers.dev/livevalues';
            const WORKER_TRIGGER_SECRET = "YOUR_SUPER_SECRET_KEY_HERE_FOR_PRIVILEGED_EXECUTION";
            const SIGNUP_COOLDOWN_KEY = 'stock_simulator_last_signup';
            const FAVORITES_KEY = 'stock_simulator_favorites';
            const ONE_DAY_MS = 24 * 60 * 60 * 1000;

            const defaultSymbols = ['AAPL', 'GOOGL', 'MSFT', 'TSLA', 'AMZN', 'NVDA', 'META', 'JPM', 'V', 'NFLX'];
            const PreloadedNames = {
                'AAPL': 'Apple Inc.', 'MSFT': 'Microsoft Corp.', 'GOOGL': 'Alphabet Inc. (Cl A)', 'NVDA': 'NVIDIA Corp.', 
                'META': 'Meta Platforms Inc.', 'TSLA': 'Tesla Inc.', 'AMD': 'Advanced Micro Devices', 'INTC': 'Intel Corp.',
                'SPY': 'SPDR S&P 500 ETF Trust', 'QQQ': 'Invesco QQQ Trust', 'VOO': 'Vanguard S&P 500 ETF',
                'HAS': 'Hasbro Inc.', 'MAT': 'Mattel Inc.', 'HD': 'Home Depot Inc.', 'WMT': 'Walmart Inc.',
                'JPM': 'JPMorgan Chase', 'BAC': 'Bank of America', 'JNJ': 'Johnson & Johnson', 'PFE': 'Pfizer Inc.',
                'PG': 'Procter & Gamble', 'KO': 'Coca-Cola', 'PEP': 'PepsiCo', 'XOM': 'Exxon Mobil', 'CVX': 'Chevron'
            };

            const filterCategories = {
                all: [...defaultSymbols],
                tech: ['AAPL', 'MSFT', 'GOOGL', 'NVDA', 'META', 'TSLA', 'AMD', 'INTC'],
                etf: ['SPY', 'QQQ', 'VOO', 'VTI', 'GLD', 'SLV'],
                home: ['HD', 'LOW', 'WMT', 'TGT'],
                finanzas: ['JPM', 'BAC', 'WFC', 'C', 'GS', 'MS'],
                salud: ['JNJ', 'PFE', 'UNH', 'MRK', 'ABBV', 'LLY'],
                consumo: ['PG', 'KO', 'PEP', 'MCD', 'NKE', 'COST'],
                energia: ['XOM', 'CVX', 'SHEL', 'TTE', 'BP']
            };

            const state = {
                authToken: null,
                username: null,
                cash: 0,
                portfolio: {},
                marketStocks: [],
                currentSymbols: [...defaultSymbols],
                nameMap: {...PreloadedNames},
                currentTrade: {},
                dailyProfitLoss: null,
                previousDayPortfolioValue: 0,
                activeFilter: 'all',
                triggers: {},
                isCheckingTriggers: false,
                totalPortfolioValue: 0,
                currentShortExposure: 0,
                historicalDataCache: {},
                favorites: new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]')),
                costBasis: {} // Stores { symbol: avgPrice }
            };
            
            let isLoginMode = true;
            let marketDataInterval = null;
            let leaderboardInterval = null;
            let triggerCheckInterval = null;
            let marketTimerInterval = null;
            
            const MARKET_DATA_UPDATE_INTERVAL_MS = 3000;
            const LEADERBOARD_UPDATE_INTERVAL_MS = 3000;
            const TRIGGER_CHECK_INTERVAL_MS = 30000;

            // DOM References
            const globalLoadingOverlay = document.getElementById('global-loading-overlay');
            const authView = document.getElementById('auth-view');
            const mainAppView = document.getElementById('main-app-view');
            const authForm = document.getElementById('auth-form');
            const authTitle = document.getElementById('auth-title');
            const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
            const authSubmitButton = document.getElementById('auth-submit-button');
            const authButtonText = document.getElementById('auth-button-text');
            const logoutButton = document.getElementById('logout-button');
            const historyButton = document.getElementById('history-button');
            const cashBalanceEl = document.getElementById('cash-balance');
            const totalValueEl = document.getElementById('total-value');
            const dailyProfitLossEl = document.getElementById('daily-profit-loss');
            const stockMarketListEl = document.getElementById('stock-market-list');
            const portfolioListEl = document.getElementById('portfolio-list');
            const welcomeMessageEl = document.getElementById('welcome-message');
            const searchInputEl = document.getElementById('search-input');
            const notificationArea = document.getElementById('notification-area');
            const marketLoader = document.getElementById('market-loader');
            const leaderboardListEl = document.getElementById('leaderboard-list');
            const chartModal = document.getElementById('chart-modal');
            const chartModalTitleEl = document.getElementById('chart-modal-title');
            const closeChartModalButton = document.getElementById('close-chart-modal-button');
            const tradingviewContainer = document.getElementById('tradingview-container');
            const chartLoader = document.getElementById('chart-loader');
            const chartErrorMessage = document.getElementById('chart-error-message');
            const historyModal = document.getElementById('history-modal');
            const closeHistoryModalButton = document.getElementById('close-history-modal-button');
            const tradeHistoryListEl = document.getElementById('trade-history-list');
            const historyLoadingStatusEl = document.getElementById('history-loading-status');
            const dailySummaryTextEl = document.getElementById('daily-summary-text');
            const dailySummaryErrorEl = document.getElementById('daily-summary-error');
            
            // Buttons
            const topGainersButton = document.getElementById('top-gainers-button');
            const topLosersButton = document.getElementById('top-losers-button');
            const canAffordButton = document.getElementById('can-afford-button');
            const aiRecommendationsButton = document.getElementById('ai-recommendations-button');
            const filterContainer = document.getElementById('filter-container');
            const filterButtons = document.querySelectorAll('.filter-btn');

            // Tabs
            const tabMarket = document.getElementById('tab-market');
            const tabFavorites = document.getElementById('tab-favorites');
            const tabTriggers = document.getElementById('tab-triggers');
            const marketContent = document.getElementById('market-content');
            const triggersContent = document.getElementById('triggers-content');
            const marketHeading = document.getElementById('market-heading');

            // Triggers
            const createTriggerForm = document.getElementById('create-trigger-form');
            const triggerSymbolEl = document.getElementById('trigger-symbol');
            const triggerQuantityEl = document.getElementById('trigger-quantity');
            const triggerActionEl = document.getElementById('trigger-action');
            const executionTypeEl = document.getElementById('execution-type');
            const priceConditionsEl = document.getElementById('price-conditions');
            const timeConditionsEl = document.getElementById('time-conditions');
            const triggerConditionEl = document.getElementById('trigger-condition');
            const triggerPriceEl = document.getElementById('trigger-price');
            const triggerDateEl = document.getElementById('trigger-date');
            const triggerTimeEl = document.getElementById('trigger-time');
            const triggerSubmitButton = document.getElementById('trigger-submit-button');
            const activeTriggersListEl = document.getElementById('active-triggers-list');
            
            // Trade Modal
            const modal = document.getElementById('trade-modal');
            const modalTitleEl = document.getElementById('modal-title');
            const sharesInputEl = document.getElementById('shares-input');
            const modalTotalCostEl = document.getElementById('modal-total-cost');
            const modalCashRemainingEl = document.getElementById('modal-cash-remaining');
            const cashRemainingLabel = document.getElementById('cash-remaining-label');
            const cancelButtonEl = document.getElementById('cancel-button');
            const confirmButtonEl = document.getElementById('confirm-button');
            
            // Timer
            const timerStatusEl = document.getElementById('timer-status');
            const timerDisplayEl = document.getElementById('timer-display');

            function showLoader() { marketLoader.classList.remove('hidden'); }
            function hideLoader() { marketLoader.classList.add('hidden'); }
            function showGlobalLoader() { globalLoadingOverlay.classList.add('visible'); authView.classList.add('hidden'); }
            function hideGlobalLoader() { globalLoadingOverlay.classList.remove('visible'); }

            function setButtonLoading(buttonElement, originalText, isLoading, loadingText = 'Cargando...') {
                if (isLoading) {
                    buttonElement.dataset.originalText = originalText;
                    buttonElement.textContent = loadingText;
                    buttonElement.disabled = true;
                    buttonElement.style.opacity = '0.7';
                } else {
                    buttonElement.textContent = buttonElement.dataset.originalText || originalText;
                    buttonElement.disabled = false;
                    buttonElement.style.opacity = '1';
                }
            }

            // --- COST BASIS CALCULATION (SINCE PURCHASE) ---
            async function calculateCostBasisFromHistory() {
                try {
                    const data = await authedFetch('/tradehistory');
                    const trades = Object.values(data).sort((a, b) => a.time - b.time); // Oldest first
                    
                    const holdings = {}; // { symbol: { qty: 0, totalCost: 0 } }

                    trades.forEach(trade => {
                        const sym = trade.symbol;
                        const qty = trade.quantity;
                        const price = trade.price;
                        const action = trade.action; // 'buy' or 'sell'

                        if (!holdings[sym]) holdings[sym] = { qty: 0, totalCost: 0 };

                        if (action === 'buy') {
                            // Weighted Average Cost Logic
                            holdings[sym].totalCost += (qty * price);
                            holdings[sym].qty += qty;
                        } else if (action === 'sell') {
                            // Reduce totalCost proportionally when selling
                            if (holdings[sym].qty > 0) {
                                const avgCost = holdings[sym].totalCost / holdings[sym].qty;
                                holdings[sym].totalCost -= (qty * avgCost);
                                holdings[sym].qty -= qty;
                            } else {
                                // Short Selling Logic (Simplified: Treat as negative qty, negative cost basis?)
                                // For simplicity in this simulation, if going short, we reset cost basis to current price
                                holdings[sym].qty -= qty;
                                holdings[sym].totalCost -= (qty * price); 
                            }
                        }
                        // Safety reset
                        if (Math.abs(holdings[sym].qty) < 0.0001) {
                            holdings[sym].totalCost = 0;
                            holdings[sym].qty = 0;
                        }
                    });

                    // Calculate Final Average Prices
                    const finalCostBasis = {};
                    for (const sym in holdings) {
                        if (holdings[sym].qty !== 0) {
                            finalCostBasis[sym] = Math.abs(holdings[sym].totalCost / holdings[sym].qty);
                        }
                    }
                    state.costBasis = finalCostBasis;
                } catch (error) {
                    console.error("Error calculating cost basis:", error);
                }
            }

            // --- INIT ---
            async function startAppLoadingSequence() {
                try {
                    await initializeMainApp();
                    hideGlobalLoader();
                    authView.classList.add('hidden'); 
                    mainAppView.classList.remove('hidden');
                    mainAppView.style.opacity = '1';
                } catch (error) {
                    hideGlobalLoader(); 
                    showNotification(`Error: ${error.message}`, 'error');
                    handleLogout();
                }
            }

            async function checkForSavedSession() {
                const savedUsername = localStorage.getItem('stock_simulator_username');
                const savedPassword = localStorage.getItem('stock_simulator_password');
                if (savedUsername && savedPassword) {
                    try {
                        showGlobalLoader();
                        const response = await fetch(`${API_BASE_URL}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username: savedUsername, password: savedPassword }),
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.message || 'Error en la autenticaci칩n');
                        state.authToken = data.token;
                        state.username = savedUsername;
                        showNotification(`Bienvenido de nuevo, ${savedUsername}`, 'info');
                        await startAppLoadingSequence();
                    } catch (error) {
                        hideGlobalLoader();
                        localStorage.removeItem('stock_simulator_username');
                        localStorage.removeItem('stock_simulator_password');
                        state.authToken = null;
                        state.username = null;
                        authView.classList.remove('hidden');
                        mainAppView.classList.add('hidden');
                    }
                } else {
                    hideGlobalLoader();
                    authView.classList.remove('hidden');
                    mainAppView.classList.add('hidden');
                }
            }

            async function initializeMainApp() {
                welcomeMessageEl.textContent = `Bienvenido, ${state.username}`;
                updateFilterButtons(); 
                await fetchUserMoney();
                await fetchUserPortfolio();
                await fetchMyTriggers();
                
                // Calculate Cost Basis First
                await calculateCostBasisFromHistory();
                
                await fetchHistoricalDataAndInitialMarket(); 

                if (marketDataInterval) clearInterval(marketDataInterval);
                if (leaderboardInterval) clearInterval(leaderboardInterval);
                if (triggerCheckInterval) clearInterval(triggerCheckInterval); 
                if (marketTimerInterval) clearInterval(marketTimerInterval);

                marketDataInterval = setInterval(updateLiveMarketData, MARKET_DATA_UPDATE_INTERVAL_MS);
                leaderboardInterval = setInterval(fetchLeaderboardData, LEADERBOARD_UPDATE_INTERVAL_MS);
                triggerCheckInterval = setInterval(checkAllUserTriggers, TRIGGER_CHECK_INTERVAL_MS);
                marketTimerInterval = setInterval(updateMarketTimerDisplay, 1000);

                updateMarketTimerDisplay();
                fetchLeaderboardData();
                fetchDailySummary();
            }

            async function fetchUserMoney() {
                try {
                    const data = await authedFetch('/money');
                    state.cash = data.cash;
                    cashBalanceEl.textContent = `$${state.cash.toFixed(2)}`;
                } catch (error) { console.error(error); }
            }

            async function fetchUserPortfolio() {
                try {
                    const data = await authedFetch('/trades');
                    state.portfolio = data || {};
                } catch (error) { state.portfolio = {}; }
            }

            // --- LOCAL P/L CALCULATION ---
            function calculateLocalDailyProfitLoss() {
                let totalDailyPL = 0;
                let totalPLPercentage = 0;

                for (const symbol in state.portfolio) {
                    const qty = state.portfolio[symbol];
                    const stock = state.marketStocks.find(s => s.symbol === symbol);
                    if (stock && stock.change !== undefined) {
                        // Daily P/L = Today's Change * Quantity
                        // If Long (qty > 0): Price up (+), P/L up (+)
                        // If Short (qty < 0): Price up (+), P/L down (-) -> logic: change * qty handles signs automatically?
                        // Buy 10. Change +5. P/L = 10*5 = +50. Correct.
                        // Short 10 (qty -10). Change +5. P/L = -10*5 = -50. Correct.
                        totalDailyPL += (stock.change * qty);
                    }
                }
                
                // Percentage relative to Portfolio Value (approximately)
                if (state.totalPortfolioValue > 0) {
                    totalPLPercentage = (totalDailyPL / state.totalPortfolioValue) * 100;
                }

                return { amount: totalDailyPL, percentage: totalPLPercentage };
            }

            function updateTotalValue() {
                let portfolioValue = 0;
                let currentShortExposure = 0;

                for (const symbol in state.portfolio) {
                    const quantity = state.portfolio[symbol];
                    const stockData = state.marketStocks.find(s => s.symbol === symbol);
                    if (stockData) {
                        const marketValue = stockData.price * quantity;
                        portfolioValue += marketValue;
                        if (quantity < 0) currentShortExposure += Math.abs(marketValue);
                    }
                }
                state.totalPortfolioValue = state.cash + portfolioValue;
                state.currentShortExposure = currentShortExposure;
                totalValueEl.textContent = `$${state.totalPortfolioValue.toFixed(2)}`;
                document.title = `$${state.totalPortfolioValue.toFixed(2)} | Tradeator`;

                // Update Daily P/L Locally
                const dailyPL = calculateLocalDailyProfitLoss();
                const plClass = dailyPL.amount >= 0 ? 'profit' : 'loss';
                const plSign = dailyPL.amount >= 0 ? '+' : '';
                dailyProfitLossEl.innerHTML = `
                    <p class="font-semibold ${plClass}">
                        B/P Diario: ${plSign}${dailyPL.amount.toFixed(2)}$ (${plSign}${dailyPL.percentage.toFixed(2)}%)
                    </p>
                `;
            }

            // --- FAVORITES LOGIC ---
            function toggleFavorite(symbol) {
                if (state.favorites.has(symbol)) {
                    state.favorites.delete(symbol);
                } else {
                    state.favorites.add(symbol);
                }
                localStorage.setItem(FAVORITES_KEY, JSON.stringify([...state.favorites]));
                
                // Refresh Views
                if (state.activeFilter === 'favorites') {
                    state.currentSymbols = [...state.favorites];
                    fetchHistoricalDataAndInitialMarket();
                } else {
                    renderMarket(); // Just re-render to update star icon
                }
            }

            // --- CORE DATA FETCHING ---
            async function fetchHistoricalDataAndInitialMarket() {
                showLoader();
                // Always include Favorites in the fetch list so we have their data ready
                const allSymbolsToInitialize = new Set([
                    ...defaultSymbols, 
                    ...state.currentSymbols, 
                    ...Object.keys(state.portfolio), 
                    ...Object.values(state.triggers).map(t => t.symbol),
                    ...state.favorites 
                ]);
                const symbolsForHistoryFetch = Array.from(allSymbolsToInitialize);
                
                if (symbolsForHistoryFetch.length > 0) {
                    try {
                        const historyRes = await fetch(`${API_BASE_URL}/history?symbol=${symbolsForHistoryFetch.join(',')}&days=10`);
                        if (historyRes.ok) {
                            const data = await historyRes.json();
                            Object.assign(state.historicalDataCache, data.results || {});
                            
                            for (const symbol in data.results) {
                                const meta = data.results[symbol]['Meta Data'];
                                if (meta && meta['ShortName'] && meta['ShortName'] !== symbol) {
                                    state.nameMap[symbol] = meta['ShortName'];
                                }
                            }
                        }
                    } catch (error) { console.error(error); }
                }

                const newMasterMarketStocks = []; // Fixed Variable Name
                const symbolsAlreadyProcessed = new Set();
                
                // Decide which symbols to show in the "Market" list based on filter
                let symbolsToDisplayList = state.currentSymbols;
                if (state.activeFilter === 'favorites') {
                    symbolsToDisplayList = [...state.favorites];
                }

                // We need to build the marketStocks array for EVERYTHING we are tracking (Portfolio + Displayed + Favorites)
                // But renderMarket will filter what is shown.
                const combinedSymbols = new Set([...symbolsToDisplayList, ...Object.keys(state.portfolio), ...state.favorites]);

                for (const symbol of combinedSymbols) {
                    if (symbolsAlreadyProcessed.has(symbol)) continue;
                    const hist = state.historicalDataCache[symbol];
                    let stockPrice, stockChange = 0, stockChangesPercentage = 0, stockHistory = [];
                    let stockName = state.nameMap[symbol] || symbol; 

                    if (hist && hist['Time Series']) {
                        const historyEntries = Object.entries(hist['Time Series']).sort(([dateA], [dateB]) => new Date(dateA) - new Date(dateB));
                        stockHistory = historyEntries.map(([, data]) => parseFloat(data['4. close']));
                        
                        if (stockHistory.length >= 2) {
                            const latestClose = stockHistory[stockHistory.length - 1];
                            const previousClose = stockHistory[stockHistory.length - 2];
                            stockChange = latestClose - previousClose;
                            stockChangesPercentage = (previousClose !== 0) ? (stockChange / previousClose) * 100 : 0;
                        }
                        if (hist['Meta Data']?.['ShortName']) stockName = hist['Meta Data']['ShortName'];
                    }
                    
                    // Fallback or Live Price logic
                    const currentLivePriceInState = state.marketStocks.find(s => s.symbol === symbol)?.price;
                    if (currentLivePriceInState !== undefined) stockPrice = currentLivePriceInState;
                    else if (stockHistory.length > 0) stockPrice = stockHistory[stockHistory.length - 1];
                    else continue;

                    newMasterMarketStocks.push({
                        symbol, name: stockName, price: stockPrice, change: stockChange, changesPercentage: stockChangesPercentage, history: stockHistory
                    });
                    symbolsAlreadyProcessed.add(symbol);
                }
                state.marketStocks = newMasterMarketStocks; 
                hideLoader();
                await updateLiveMarketData(); 
            }

            async function updateLiveMarketData(externalLiveValues = {}) {
                const symbolsToRefresh = new Set();
                state.marketStocks.forEach(stock => symbolsToRefresh.add(stock.symbol)); 
                
                const symbolsString = Array.from(symbolsToRefresh).join(',');
                if (symbolsString.length === 0) { renderMarket(); renderPortfolio(); updateTotalValue(); return; }
                
                let liveValuesData = externalLiveValues;
                if (Object.keys(liveValuesData).length === 0) {
                     try {
                        const liveValuesRes = await fetch(`${API_LIVE_VALUES_URL}/${symbolsString}`);
                        if (liveValuesRes.ok) {
                            const data = await liveValuesRes.json();
                            liveValuesData = data.liveValues || {};
                        }
                    } catch (error) { console.error(error); }
                }

                state.marketStocks = state.marketStocks.map(stock => {
                    const livePrice = liveValuesData[stock.symbol];
                    if (livePrice !== undefined && !isNaN(livePrice)) {
                        let prevPrice = stock.price;
                        // Recalculate change based on History's last close, not just previous tick
                        const hist = state.historicalDataCache[stock.symbol]?.['Time Series'];
                        if (hist) {
                            const dates = Object.keys(hist).sort();
                            if (dates.length >= 2) prevPrice = parseFloat(hist[dates[dates.length - 2]]['4. close']);
                        }

                        const newChange = livePrice - prevPrice;
                        const newChangePercent = (prevPrice !== 0) ? (newChange / prevPrice) * 100 : 0;
                        return { ...stock, price: livePrice, change: newChange, changesPercentage: newChangePercent };
                    }
                    return stock; 
                });
                renderMarket(); renderPortfolio(); updateTotalValue();
            }

            function renderMarket() {
                stockMarketListEl.innerHTML = '';
                
                // Filter logic
                let stocksToDisplay = [];
                if (state.activeFilter === 'favorites') {
                    stocksToDisplay = state.marketStocks.filter(s => state.favorites.has(s.symbol));
                    if (stocksToDisplay.length === 0) {
                        stockMarketListEl.innerHTML = `<p class="text-gray-400 text-center py-4">No tienes favoritos a침adidos.</p>`;
                        return;
                    }
                } else {
                    stocksToDisplay = state.marketStocks.filter(s => state.currentSymbols.includes(s.symbol));
                }

                if(stocksToDisplay.length === 0) {
                    stockMarketListEl.innerHTML = `<p class="text-gray-400 text-center py-4">No se encontraron acciones.</p>`;
                    return;
                }
                
                stocksToDisplay.forEach(stock => {
                    const { symbol, price, change, changesPercentage, history } = stock;
                    const changeClass = change >= 0 ? 'stock-up' : 'stock-down';
                    const changeSign = change >= 0 ? '+' : '';
                    const isFav = state.favorites.has(symbol);
                    const starClass = isFav ? 'favorite-active' : 'favorite-inactive';

                    const el = document.createElement('div');
                    el.className = 'stock-item grid grid-cols-3 md:grid-cols-5 items-center bg-gray-900 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50';
                    el.dataset.symbol = symbol;
                    el.innerHTML = `
                        <div class="col-span-2 md:col-span-2 flex items-center gap-2">
                            <button class="fav-btn focus:outline-none" data-symbol="${symbol}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${starClass}" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                </svg>
                            </button>
                            <div>
                                <p class="font-bold text-lg">${symbol}</p>
                                <p class="text-sm text-gray-400 truncate">${stock.name}</p>
                            </div>
                        </div>
                        <div class="hidden md:block">${generateSparkline(history, change)}</div>
                        <div class="text-right">
                            <p class="font-semibold text-lg">$${price.toFixed(2)}</p>
                            <p class="text-sm ${changeClass}">${changeSign}${change.toFixed(2)}$ (${changeSign}${changesPercentage.toFixed(2)}%)</p>
                        </div>
                        <div class="flex flex-col md:flex-row justify-end ml-2 space-y-1 md:space-y-0 md:space-x-1">
                            <button data-symbol="${symbol}" data-type="buy" class="trade-btn text-xs font-bold bg-green-600 hover:bg-green-500 text-white py-1 px-2 rounded-md">COMPRAR</button>
                            <button data-symbol="${symbol}" data-type="sell" class="trade-btn text-xs font-bold bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded-md">VENDER</button>
                        </div>`;
                    stockMarketListEl.appendChild(el);
                });
            }

            function renderPortfolio() {
                portfolioListEl.innerHTML = '';
                if (Object.keys(state.portfolio).length === 0) {
                    portfolioListEl.innerHTML = `<p class="text-gray-400">A칰n no tienes acciones.</p>`;
                    return;
                }
                for (const symbol in state.portfolio) {
                    const quantity = state.portfolio[symbol];
                    if (quantity === 0) continue;

                    const stockData = state.marketStocks.find(s => s.symbol === symbol);
                    const currentPrice = stockData ? stockData.price : 0;
                    const currentValue = currentPrice * quantity;
                    const priceDisplay = stockData ? `@ ${stockData.price.toFixed(2)}` : 'Cargando...';

                    // --- TOTAL P/L CALCULATION (SINCE PURCHASE) ---
                    let plHtml = '';
                    const avgCost = state.costBasis[symbol];
                    
                    if (avgCost && stockData) {
                        // Total P/L = (Current Price - Avg Cost) * Quantity
                        // If Short (qty < 0): (Avg Cost - Current Price) * Abs(Qty) -> Same formula if qty is negative?
                        // Buy 10 @ 100. Curr 120. (120-100)*10 = +200. Correct.
                        // Short 10 @ 100. Curr 80. (80-100)*(-10) = (-20)*(-10) = +200. Correct.
                        const totalPL = (currentPrice - avgCost) * quantity;
                        const totalPLPercent = (avgCost > 0) ? ((currentPrice - avgCost) / avgCost) * 100 * (quantity > 0 ? 1 : -1) : 0;

                        const plClass = totalPL >= 0 ? 'profit' : 'loss';
                        const plSign = totalPL >= 0 ? '+' : '';
                        
                        plHtml = `
                            <p class="text-sm ${plClass} font-bold" title="Desde compra">
                                Total: ${plSign}${totalPL.toFixed(2)}$ (${plSign}${totalPLPercent.toFixed(2)}%)
                            </p>`;
                    } else {
                        // Fallback to Daily if no history found (should happen rarely)
                        plHtml = `<p class="text-xs text-gray-500">Sin datos hist칩ricos</p>`;
                    }

                    const posType = quantity > 0 ? 'Long' : 'Short';
                    const posColor = quantity > 0 ? 'text-green-400' : 'text-red-400';
                    const absQuantity = Math.abs(quantity);
                    const displayValue = Math.abs(currentValue);

                    const el = document.createElement('div');
                    el.className = 'stock-item bg-gray-900 p-4 rounded-lg cursor-pointer hover:bg-gray-700/50';
                    el.dataset.symbol = symbol; 
                    el.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-lg">${symbol}</p>
                                <p class="text-sm text-gray-400">${absQuantity} acciones (<span class="${posColor} font-semibold">${posType}</span>)</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-lg">$${displayValue.toFixed(2)}</p>
                                <p class="text-sm text-gray-500">${priceDisplay}</p>
                                ${plHtml}
                            </div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <button data-symbol="${symbol}" data-type="buy" class="trade-btn w-full text-xs font-bold bg-green-600 hover:bg-green-500 text-white py-1 px-2 rounded-md">${quantity < 0 ? 'CUBRIR' : 'COMPRAR'}</button>
                            <button data-symbol="${symbol}" data-type="sell" class="trade-btn w-full text-xs font-bold bg-red-600 hover:bg-red-500 text-white py-1 px-2 rounded-md">${quantity > 0 ? 'VENDER' : 'V. CORTO'}</button>
                        </div>`;
                    portfolioListEl.appendChild(el);
                }
            }

            function generateSparkline(history, change) {
                if (!history || history.length < 2) return '';
                const width = 100; const height = 30;
                const max = Math.max(...history); const min = Math.min(...history);
                const range = max - min === 0 ? 1 : max - min; 
                const points = history.map((d, i) => {
                    const x = (i / (history.length - 1)) * width;
                    const y = height - ((d - min) / range) * height;
                    return `${x.toFixed(2)},${y.toFixed(2)}`;
                }).join(' ');
                const strokeColor = change >= 0 ? '#22C55E' : '#EF4444';
                return `<svg viewBox="0 0 ${width} ${height}" class="w-24 h-8" preserveAspectRatio="none"><polyline fill="none" stroke="${strokeColor}" stroke-width="1.5" points="${points}" /></svg>`;
            }

            // --- ACTIONS & HANDLERS ---
            async function handleAuthSubmit(e) {
                e.preventDefault();
                const username = authForm.username.value;
                const password = authForm.password.value;
                const endpoint = isLoginMode ? '/login' : '/signup';
                
                if (!isLoginMode) {
                    const lastSignup = localStorage.getItem(SIGNUP_COOLDOWN_KEY);
                    if (lastSignup && (Date.now() - parseInt(lastSignup)) < ONE_DAY_MS) {
                        showNotification('L칤mite diario de cuentas alcanzado.', 'error'); return;
                    }
                }

                setButtonLoading(authSubmitButton, authButtonText.textContent, true);
                try {
                    const res = await fetch(`${API_BASE_URL}${endpoint}`, { 
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username, password}) 
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    
                    if (isLoginMode) {
                        state.authToken = data.token;
                        state.username = username;
                        localStorage.setItem('stock_simulator_username', username);
                        localStorage.setItem('stock_simulator_password', password);
                        await startAppLoadingSequence();
                    } else {
                        localStorage.setItem(SIGNUP_COOLDOWN_KEY, Date.now().toString());
                        showNotification('Cuenta creada.', 'success');
                        toggleAuthMode();
                    }
                } catch (error) { showNotification(error.message, 'error'); }
                finally { setButtonLoading(authSubmitButton, '', false); }
            }

            async function fetchTopStocks(endpoint, buttonElement) {
                const originalText = buttonElement.textContent;
                setButtonLoading(buttonElement, originalText, true);
                state.activeFilter = null; updateFilterButtons(); searchInputEl.value = ''; 

                try {
                    const res = await fetch(`${API_BASE_URL}${endpoint}`);
                    if (!res.ok) throw new Error('Error al cargar.');
                    const data = await res.json(); 
                    if (data && data.length > 0) {
                        state.currentSymbols = data.map(item => item.symbol);
                        data.forEach(item => { 
                            state.nameMap[item.symbol] = item.name || item.symbol; 
                        });
                        // Update market view with new list
                        const newMarketStocks = []; // Correctly defined locally
                        // (Logic simplified: Rely on fetchHistoricalDataAndInitialMarket to do the heavy lifting for consistency)
                        await fetchHistoricalDataAndInitialMarket();
                    } else {
                        showNotification('Sin resultados.', 'info');
                        state.currentSymbols = [...defaultSymbols];
                        await fetchHistoricalDataAndInitialMarket();
                    }
                } catch (error) {
                    showNotification(error.message, 'error');
                } finally { setButtonLoading(buttonElement, originalText, false); }
            }

            // Trade Logic Wrapper
            async function executeTrade() {
                const { symbol, type } = state.currentTrade;
                const quantity = parseInt(sharesInputEl.value);
                if(!quantity || quantity <= 0) return;
                
                const stock = state.marketStocks.find(s => s.symbol === symbol);
                const tradeValue = quantity * stock.price;
                
                // Margin Check
                const equity = Math.max(0, state.totalPortfolioValue);
                if (type === 'sell') {
                    const currentHolding = state.portfolio[symbol] || 0;
                    const newHolding = currentHolding - quantity;
                    if (newHolding < 0) {
                        let projectedShortDebt = state.currentShortExposure;
                        // Subtract current symbol exposure from total if any
                        if (currentHolding < 0) projectedShortDebt -= Math.abs(currentHolding * stock.price);
                        // Add new exposure
                        projectedShortDebt += Math.abs(newHolding * stock.price);

                        if (projectedShortDebt > equity * 10) {
                            showNotification('L칤mite de margen excedido (10x).', 'error'); return;
                        }
                    }
                } else if (type === 'buy' && tradeValue > state.cash) {
                    showNotification('Fondos insuficientes.', 'error'); return;
                }

                const btnText = confirmButtonEl.textContent;
                setButtonLoading(confirmButtonEl, btnText, true);
                try {
                    const endpoint = type === 'buy' ? '/trades/add' : '/trades/sell';
                    await authedFetch(endpoint, { method: 'POST', body: JSON.stringify({symbol, quantity}) });
                    
                    // Refresh all data including cost basis
                    await Promise.all([fetchUserPortfolio(), fetchUserMoney()]);
                    await calculateCostBasisFromHistory(); // Recalc average cost
                    updateLiveMarketData();
                    fetchLeaderboardData();
                    showNotification('Operaci칩n exitosa', 'success');
                    closeTradeModal();
                } catch (err) { showNotification(err.message, 'error'); }
                finally { setButtonLoading(confirmButtonEl, btnText, false); }
            }

            // Standard Utils
            function toggleAuthMode(e) { if(e) e.preventDefault(); isLoginMode = !isLoginMode; authTitle.textContent = isLoginMode ? 'Iniciar Sesi칩n' : 'Crear Cuenta'; authButtonText.textContent = isLoginMode ? 'Iniciar Sesi칩n' : 'Crear Cuenta'; toggleAuthModeLink.textContent = isLoginMode ? 'crea una cuenta nueva' : 'inicia sesi칩n con una cuenta existente'; }
            function handleLogout() { location.reload(); localStorage.removeItem('stock_simulator_username'); localStorage.removeItem('stock_simulator_password'); }
            async function authedFetch(endpoint, opts={}) {
                const h = {...opts.headers, 'Authorization': `Bearer ${state.authToken}`, 'Content-Type': 'application/json'};
                const r = await fetch(`${API_BASE_URL}${endpoint}`, {...opts, headers: h});
                if (!r.ok) { const e = await r.json().catch(()=>({})); throw new Error(e.message||'Error'); }
                return r.json();
            }
            function showNotification(msg, type='info') {
                const colors = {error:'bg-red-500', success:'bg-green-500', warning:'bg-yellow-500', info:'bg-blue-500'};
                const el = document.createElement('div');
                el.className = `notification ${colors[type]} text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2`;
                el.textContent = msg; notificationArea.appendChild(el);
                setTimeout(()=> { el.style.opacity='1'; el.style.transform='translateY(0)'; }, 10);
                setTimeout(()=> { el.style.opacity='0'; setTimeout(()=>el.remove(),500); }, 4000);
            }

            // New Event Listeners
            stockMarketListEl.addEventListener('click', e => {
                const favBtn = e.target.closest('.fav-btn');
                if (favBtn) {
                    e.stopPropagation();
                    toggleFavorite(favBtn.dataset.symbol);
                    return;
                }
                if (e.target.closest('.trade-btn')) openTradeModal(e);
                else if (e.target.closest('.stock-item')) openChartModal(e.target.closest('.stock-item').dataset.symbol);
            });
            
            portfolioListEl.addEventListener('click', e => {
                if (e.target.closest('.trade-btn')) { openTradeModal(e); } 
                else { const stockItem = e.target.closest('.stock-item'); if (stockItem && stockItem.dataset.symbol) { openChartModal(stockItem.dataset.symbol); } }
            });

            // Tab Logic
            function switchTab(tab) {
                [tabMarket, tabFavorites, tabTriggers].forEach(t => t.classList.remove('active'));
                [marketContent, triggersContent].forEach(c => c.classList.add('hidden'));
                
                if (tab === 'market') {
                    tabMarket.classList.add('active');
                    marketContent.classList.remove('hidden');
                    state.activeFilter = 'all'; 
                    updateFilterButtons(); // Reset filters visually
                    marketHeading.textContent = 'Mercado de Acciones';
                    state.currentSymbols = [...defaultSymbols]; // Reset to default
                    fetchHistoricalDataAndInitialMarket();
                } else if (tab === 'favorites') {
                    tabFavorites.classList.add('active');
                    marketContent.classList.remove('hidden');
                    state.activeFilter = 'favorites';
                    marketHeading.textContent = 'Mis Favoritos';
                    fetchHistoricalDataAndInitialMarket();
                } else if (tab === 'triggers') {
                    tabTriggers.classList.add('active');
                    triggersContent.classList.remove('hidden');
                }
            }
            
            tabMarket.addEventListener('click', () => switchTab('market'));
            tabFavorites.addEventListener('click', () => switchTab('favorites'));
            tabTriggers.addEventListener('click', () => switchTab('triggers'));

            // Remaining handlers
            toggleAuthModeLink.addEventListener('click', toggleAuthMode);
            authForm.addEventListener('submit', handleAuthSubmit);
            logoutButton.addEventListener('click', handleLogout);
            searchInputEl.addEventListener('input', (e) => {
                const q = e.target.value.trim();
                if (q) { state.activeFilter = null; updateFilterButtons(); }
                clearTimeout(window.searchTimeout);
                window.searchTimeout = setTimeout(async () => {
                    if (!q) { state.currentSymbols = [...defaultSymbols]; }
                    else {
                        try {
                            const res = await fetch(`${API_BASE_URL}/search/${q}`);
                            const data = await res.json();
                            state.currentSymbols = data.map(i => i.symbol);
                            data.forEach(i => state.nameMap[i.symbol] = i.name);
                        } catch (e) { state.currentSymbols = []; }
                    }
                    fetchHistoricalDataAndInitialMarket();
                }, 500);
            });
            
            filterContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('.filter-btn');
                if (!btn) return;
                const f = btn.dataset.filter;
                state.activeFilter = f; updateFilterButtons();
                state.currentSymbols = filterCategories[f] || [...defaultSymbols];
                fetchHistoricalDataAndInitialMarket();
            });

            function updateFilterButtons() {
                filterButtons.forEach(b => {
                    if (b.dataset.filter === state.activeFilter) b.classList.add('active');
                    else b.classList.remove('active');
                });
            }

            // Modals & Timers
            // ... (Standard modal open/close logic preserved but compressed for brevity in this response) ...
            historyButton.addEventListener('click', () => { historyModal.classList.remove('hidden'); historyModal.classList.add('flex'); authedFetch('/tradehistory').then(d => {
                const trades = Object.values(d).sort((a,b)=>b.time-a.time);
                tradeHistoryListEl.innerHTML = '';
                trades.forEach(t => {
                    const cls = t.action === 'buy' ? 'text-green-400' : 'text-red-400';
                    tradeHistoryListEl.innerHTML += `<div class="bg-gray-900 p-3 rounded-lg flex items-center shadow-md ${t.action === 'buy' ? 'trade-row-buy' : 'trade-row-sell'}">
                        <div class="grid grid-cols-5 md:grid-cols-6 gap-2 w-full items-center text-sm">
                            <div class="${cls} font-bold col-span-1">${t.action.toUpperCase()}</div>
                            <div class="font-semibold col-span-1">${t.symbol}</div>
                            <div class="text-gray-300 hidden md:block">${t.quantity}</div>
                            <div class="text-white col-span-1">$${t.price.toFixed(2)}</div>
                            <div class="text-yellow-400 col-span-1">${t.source === 'manual' ? 'Manual' : 'Auto'}</div>
                            <div class="text-gray-400 text-right col-span-1">${new Date(t.time).toLocaleDateString()}</div>
                        </div></div>`;
                });
            }); });
            closeHistoryModalButton.addEventListener('click', () => historyModal.classList.add('hidden'));
            
            // --- CHART MODAL FUNCTIONS (MODIFIED FOR TRADINGVIEW & CRYPTO) ---
            async function openChartModal(symbol) {
                chartModalTitleEl.textContent = `Gr치fico de ${symbol} (TradingView)`;
                chartModal.classList.remove('hidden');
                chartModal.classList.add('flex');
                chartLoader.classList.remove('hidden');
                chartErrorMessage.classList.add('hidden');

                // Clear previous content
                tradingviewContainer.innerHTML = '';

                // Determine TradingView Symbol
                // Default to NASDAQ for stocks
                let tvSymbol = `NASDAQ:${symbol}`;

                // Check for Crypto signs (e.g., BTC-USD contains hyphen)
                // You can expand this logic if you add other crypto pairs that don't follow this format
                if (symbol.includes('-')) {
                    // Assume it's a crypto pair like BTC-USD. 
                    // TradingView usually recognizes these under COINBASE without the hyphen (e.g., BTCUSD)
                    const cleanSymbol = symbol.replace('-', '');
                    tvSymbol = `COINBASE:${cleanSymbol}`;
                }

                // TradingView Widget HTML (Dark theme, 100% size)
                const tvEmbedHtml = `
                    <div class="tradingview-widget-container h-full w-full">
                        <iframe
                            src="https://s.tradingview.com/widgetembed/?symbol=${tvSymbol}&amp;interval=D&amp;hidesidetoolbar=0&amp;hidetoptoolbar=0&amp;saveimage=false&amp;toolbarbg=1F2937&amp;details=false&amp;studies=RSI%40tv-basiccharts%2FMACD%40tv-basiccharts&amp;theme=dark&amp;style=1&amp;timezone=America%2FNew_York&amp;studies_overrides={}&amp;utm_source=tradeator&amp;utm_medium=widget&amp;utm_campaign=chart&amp;utm_term=${symbol}"
                            style="width: 100%; height: 100%;"
                            allowfullscreen
                            frameborder="0"
                            loading="lazy"
                        ></iframe>
                    </div>
                `;
                
                // Insert the iframe
                tradingviewContainer.innerHTML = tvEmbedHtml;
                chartLoader.classList.add('hidden');
            }

            function closeChartModal() {
                chartModal.classList.add('hidden');
                chartModal.classList.remove('flex');
                // Clear the iframe content to stop playback/loading
                document.getElementById('tradingview-container').innerHTML = '';
            }
            
            function openTradeModal(e) {
                const {symbol, type} = e.target.dataset;
                state.currentTrade = {symbol, type};
                const s = state.marketStocks.find(x => x.symbol === symbol);
                if (!s) return;
                modalTitleEl.textContent = `${type==='buy'?'Comprar':'Vender'} ${symbol}`;
                confirmButtonEl.textContent = type==='buy'?'Confirmar Compra':'Confirmar Venta';
                confirmButtonEl.className = `px-4 py-2 rounded-md font-semibold ${type==='buy'?'bg-green-600':'bg-red-600'}`;
                sharesInputEl.value = 1;
                if(type==='buy') sharesInputEl.max = Math.floor(state.cash/s.price);
                else sharesInputEl.removeAttribute('max');
                modal.classList.remove('hidden'); modal.classList.add('flex');
            }
            cancelButtonEl.addEventListener('click', () => modal.classList.add('hidden'));
            confirmButtonEl.addEventListener('click', executeTrade);
            
            function updateMarketTimerDisplay() {
                const now = new Date();
                const nyTime = new Date(now.toLocaleString("en-US", {timeZone: "America/New_York"}));
                const h = nyTime.getHours(); const m = nyTime.getMinutes();
                const isOpen = (h > 9 || (h===9 && m>=30)) && h < 16 && nyTime.getDay() !== 0 && nyTime.getDay() !== 6;
                timerStatusEl.textContent = isOpen ? '游릭 Mercado Abierto' : '游댮 Mercado Cerrado';
                timerDisplayEl.innerHTML = `<span class="${isOpen?'text-green-500':'text-red-500'}">${nyTime.toLocaleTimeString()}</span>`;
            }

            // --- NEW TRIGGER EXECUTION LOGIC FOR ALL USERS ---
             // NEW: Function to check all users' triggers against live prices
             async function checkAllUserTriggers() {
                if (state.isCheckingTriggers) {
                    return;
                }
                
                state.isCheckingTriggers = true;
                
                // 1. Fetch ALL triggers from ALL users from the new public endpoint
                let allTriggersData = {};
                try {
                    const response = await fetch(`${API_BASE_URL}/programs`);
                    if (!response.ok) throw new Error("Error al obtener todas las programaciones.");
                    allTriggersData = await response.json();
                } catch (error) {
                    console.error("Error fetching all user triggers:", error.message);
                    state.isCheckingTriggers = false;
                    return;
                }

                // 2. Identify all unique symbols involved
                const triggersMap = {}; // Map to store all active triggers for execution
                const symbolsToRefresh = new Set();
                
                for (const username in allTriggersData) {
                    for (const triggerId in allTriggersData[username]) {
                        const trigger = allTriggersData[username][triggerId];
                        triggersMap[triggerId] = trigger;
                        symbolsToRefresh.add(trigger.symbol);
                    }
                }
                
                if (symbolsToRefresh.size === 0) {
                     state.isCheckingTriggers = false;
                     return;
                }

                // 3. Get live prices for all required symbols
                const symbolsString = Array.from(symbolsToRefresh).join(',');
                let liveValuesData = {};
                try {
                    const liveValuesRes = await fetch(`${API_LIVE_VALUES_URL}/${symbolsString}`);
                    if (liveValuesRes.ok) {
                        const data = await liveValuesRes.json();
                        liveValuesData = data.liveValues || {};
                    }
                } catch (error) {
                    console.error("Error fetching live values for all triggers:", error.message);
                }
                
                // 4. Check conditions and group triggers for execution
                const triggersToExecute = [];
                const now = new Date(); 

                // Helper para obtener la fecha de ejecuci칩n en el contexto local (Espa침a)
                const getTriggerDateTimeLocal = (date, time) => {
                    // Usamos la hora local del cliente
                    return new Date(`${date}T${time}:00`); 
                };

                for (const triggerId in triggersMap) {
                    const trigger = triggersMap[triggerId];
                    const livePrice = liveValuesData[trigger.symbol];
                    let conditionMet = false;

                    if (trigger.executionType === 'price' && livePrice !== undefined) {
                        if (trigger.condition === 'lt' && livePrice <= trigger.targetPrice) {
                            conditionMet = true;
                        } else if (trigger.condition === 'gt' && livePrice >= trigger.targetPrice) {
                            conditionMet = true;
                        }
                    } else if (trigger.executionType === 'time') {
                        // Compara la fecha/hora programada con la hora actual del cliente
                        const triggerDateTime = getTriggerDateTimeLocal(trigger.date, trigger.time);
                        if (now >= triggerDateTime) {
                            conditionMet = true;
                        }
                    }

                    if (conditionMet) {
                        triggersToExecute.push(trigger);
                    }
                }
                
                // 5. Execute all triggers sequentially by calling the privileged Worker endpoint
                for (const trigger of triggersToExecute) {
                    await sendTriggerToWorkerForExecution(trigger);
                }

                // 6. Update local user data after potential changes
                if (triggersToExecute.length > 0) {
                    // CORRECCI칍N: Si se ejecut칩 AL MENOS un trigger (sin importar de qu칠 usuario fue),
                    // forzamos la recarga de los datos financieros del usuario actual, 
                    // ya que el Worker modific칩 la base de datos y estos datos pueden ser para este usuario.
                    await Promise.all([
                        fetchUserPortfolio(), 
                        fetchUserMoney(),
                        calculateCostBasisFromHistory() // Recalculate cost basis
                    ]);
                    await fetchMyTriggers(); // Recargar la lista de triggers por si se borraron
                    
                    // Asegurar que el leaderboard se refresque inmediatamente para reflejar el nuevo valor total
                    await fetchLeaderboardData(); 
                }

                // Refresh market data and internal state only for display
                if (triggersToExecute.length > 0 || symbolsToRefresh.size > 0) {
                     updateLiveMarketData(liveValuesData);
                }

                state.isCheckingTriggers = false;
            }
            
            // NEW: Function to delegate execution to the Worker
            async function sendTriggerToWorkerForExecution(trigger) {
                try {
                    const response = await fetch(`${API_BASE_URL}/triggercheck`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            trigger: trigger, 
                            secret: WORKER_TRIGGER_SECRET 
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Notificaci칩n de 칠xito (ejecuci칩n y borrado ocurrieron en el Worker)
                        const actionText = trigger.action === 'sell' ? 'VENDIDO' : 'COMPRADO';
                        const priceDisplay = result.price ? ` a $${result.price.toFixed(2)}` : '';
                        showNotification(`九 Trigger de ${trigger.username} para ${trigger.symbol}: ${actionText}${priceDisplay}.`, 'success');
                    } else {
                        // Notificaci칩n de fallo (el Worker lo borr칩 para prevenir el bucle)
                        showNotification(`仇 Fallo al ejecutar el trigger de ${trigger.username} para ${trigger.symbol}. ${result.message}`, 'error');
                    }
                    
                    // Asegurar que el trigger desaparezca localmente si se elimin칩 en el Worker
                    if (trigger.username === state.username) {
                        await fetchMyTriggers();
                    }

                } catch (error) {
                    console.error("Error al delegar la ejecuci칩n del trigger al Worker:", error);
                    showNotification(`Error de conexi칩n al intentar ejecutar el trigger de ${trigger.username}.`, 'warning');
                }
            }

            async function fetchLeaderboardData() {
                try {
                    // MODIFICACI칍N SOLICITADA: A침adir cache-buster a la URL
                    const cacheBuster = Date.now();
                    const data = await authedFetch(`/leaderboard?_t=${cacheBuster}`);
                    
                    if (data.leaderboard && data.leaderboard.length > 0) {
                        renderLeaderboard(data.leaderboard);
                    } else {
                        leaderboardListEl.innerHTML = `<p class="text-gray-400">No hay datos en la clasificaci칩n a칰n.</p>`;
                    }
                } catch (error) {
                    showNotification(`Error al cargar la clasificaci칩n: ${error.message}`, 'error');
                    leaderboardListEl.innerHTML = `<p class="text-gray-400">Error al cargar la clasificaci칩n.</p>`;
                }
            }
            
            function renderLeaderboard(leaderboardData) {
                leaderboardListEl.innerHTML = ''; 
                leaderboardData.forEach((user, index) => {
                    let liClasses = 'bg-gray-900 p-3 rounded-lg flex justify-between items-center';
                    
                    if (index === 0) {
                        liClasses += ' leaderboard-first-place'; 
                    } else if (user.username === state.username) {
                        liClasses += ' leaderboard-your-entry'; 
                    }

                    const el = document.createElement('div');
                    el.className = liClasses;
                    el.innerHTML = `
                        <div>
                            <p class="font-bold text-md">${index + 1}. ${user.username}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-md">$${user.totalPortfolioValue.toFixed(2)}</p>
                        </div>
                    `;
                    leaderboardListEl.appendChild(el);
                });
            }

            async function fetchDailySummary() {
                dailySummaryTextEl.textContent = 'Cargando resumen...'; 
                dailySummaryErrorEl.classList.add('hidden'); 
                try {
                    const response = await fetch(`${API_BASE_URL}/today`);
                    if (!response.ok) {
                        throw new Error('Error al cargar el resumen diario de la bolsa.');
                    }
                    const data = await response.json();
                    if (data && data.dailySummary) {
                        dailySummaryTextEl.textContent = data.dailySummary;
                        dailySummaryTextEl.classList.remove('hidden'); 
                    } else {
                        dailySummaryTextEl.textContent = 'No hay resumen diario disponible.';
                        dailySummaryTextEl.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error fetching daily summary:', error);
                    dailySummaryTextEl.classList.add('hidden'); 
                    dailySummaryErrorEl.textContent = `Error: ${error.message}`;
                    dailySummaryErrorEl.classList.remove('hidden'); 
                }
            }

            async function fetchMyTriggers() {
                try {
                    const data = await authedFetch('/triggers', { method: 'GET' });
                    state.triggers = data || {};
                    renderTriggers();
                } catch (error) {
                    state.triggers = {};
                    showNotification(`Error al cargar tus programaciones: ${error.message}`, 'error');
                }
            }

            function renderTriggers() {
                activeTriggersListEl.innerHTML = '';
                if (Object.keys(state.triggers).length === 0) {
                    activeTriggersListEl.innerHTML = `<p class="text-gray-400">No tienes programaciones activas.</p>`;
                    return;
                }

                for (const triggerId in state.triggers) {
                    const trigger = state.triggers[triggerId];
                    let conditionText = '';
                    let conditionColor = '';
                    let details = '';

                    const actionText = trigger.action === 'sell' ? 'Vender' : 'Comprar';
                    const actionColor = trigger.action === 'sell' ? 'text-red-400' : 'text-green-400';

                    if (trigger.executionType === 'price') {
                        conditionText = trigger.condition === 'lt' ? 'baja a menos de' : 'sube a m치s de';
                        conditionColor = trigger.condition === 'lt' ? 'text-red-400' : 'text-green-400';
                        details = `Si Precio <span class="${conditionColor}">${conditionText} $${trigger.targetPrice.toFixed(2)}</span>`;
                    } else if (trigger.executionType === 'time') {
                        conditionText = 'programada para';
                        conditionColor = 'text-blue-400';
                        details = `Ejecuci칩n <span class="${conditionColor}">${conditionText} ${trigger.date} a las ${trigger.time} (CET/CEST)</span>`;
                    }

                    const el = document.createElement('div');
                    el.className = 'bg-gray-900 p-3 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold">
                                <span class="${actionColor}">${actionText} ${trigger.quantity}</span> de ${trigger.symbol}
                            </p>
                            <p class="text-sm text-gray-400">${details}</p>
                        </div>
                        <button data-trigger-id="${triggerId}" class="delete-trigger-btn bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded-md text-sm">
                            Eliminar
                        </button>
                    `;
                    activeTriggersListEl.appendChild(el);
                }
            }

            async function handleDeleteTrigger(triggerId) {
                try {
                    const result = await authedFetch('/triggers/delete', {
                        method: 'POST',
                        body: JSON.stringify({ triggerId })
                    });
                    state.triggers = result.triggers;
                    renderTriggers();
                    showNotification('Programaci칩n eliminada de Firebase.', 'info');
                    return true;
                } catch (error) {
                    showNotification(`Error al eliminar programaci칩n: ${error.message}`, 'error');
                    return false;
                }
            }
            
            function updateTriggerFormVisibility() {
                const type = executionTypeEl.value;
                priceConditionsEl.classList.add('hidden');
                timeConditionsEl.classList.add('hidden');

                if (type === 'price') {
                    priceConditionsEl.classList.remove('hidden');
                    triggerPriceEl.required = true;
                    triggerDateEl.required = false;
                    triggerTimeEl.required = false;
                } else if (type === 'time') {
                    timeConditionsEl.classList.remove('hidden');
                    triggerPriceEl.required = false;
                    triggerDateEl.required = true;
                    triggerTimeEl.required = true;
                }
            }

            async function handleCreateTrigger(e) {
                e.preventDefault();
                const symbol = triggerSymbolEl.value.trim().toUpperCase();
                const quantity = parseInt(triggerQuantityEl.value);
                const action = triggerActionEl.value;
                const executionType = executionTypeEl.value;
                
                let payload = { symbol, quantity, executionType, action };

                if (executionType === 'price') {
                    payload.condition = triggerConditionEl.value;
                    payload.targetPrice = parseFloat(triggerPriceEl.value);
                    if (isNaN(payload.targetPrice) || payload.targetPrice <= 0) {
                         showNotification('El precio objetivo debe ser un n칰mero positivo.', 'error'); return;
                    }
                } else if (executionType === 'time') {
                    payload.date = triggerDateEl.value;
                    payload.time = triggerTimeEl.value;
                    if (!payload.date || !payload.time) {
                        showNotification('Debe seleccionar fecha y hora de ejecuci칩n.', 'error'); return;
                    }
                }

                const originalButtonText = triggerSubmitButton.textContent;
                setButtonLoading(triggerSubmitButton, originalButtonText, true);

                try {
                    const result = await authedFetch('/triggers/add', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });
                    state.triggers = result.triggers;
                    renderTriggers();
                    showNotification('Programaci칩n creada y guardada con 칠xito.', 'success');
                    createTriggerForm.reset(); 
                    updateTriggerFormVisibility();
                } catch (error) {
                    showNotification(`Error al crear programaci칩n: ${error.message}`, 'error');
                } finally {
                    setButtonLoading(triggerSubmitButton, originalButtonText, false);
                }
            }

            // Initial Calls
            createTriggerForm.addEventListener('submit', handleCreateTrigger);
            activeTriggersListEl.addEventListener('click', e => {
                const deleteButton = e.target.closest('.delete-trigger-btn');
                if (deleteButton) {
                    const triggerId = deleteButton.dataset.triggerId;
                    handleDeleteTrigger(triggerId);
                }
            });
            executionTypeEl.addEventListener('change', updateTriggerFormVisibility);
            closeChartModalButton.addEventListener('click', closeChartModal);
            chartModal.querySelector('.modal-backdrop').addEventListener('click', closeChartModal);
            sharesInputEl.addEventListener('input', updateTradeModalCalculations);
            
            function updateTradeModalCalculations() {
                const { symbol, type } = state.currentTrade;
                const stock = state.marketStocks.find(s => s.symbol === symbol);
                if (!stock) return;

                const shares = parseInt(sharesInputEl.value) || 0;
                const totalCost = shares * stock.price;
                modalTotalCostEl.textContent = `$${totalCost.toFixed(2)}`;

                let cashAfterTrade;
                if (type === 'buy') {
                    cashAfterTrade = state.cash - totalCost;
                } else {
                    cashAfterTrade = state.cash + totalCost;
                }
                modalCashRemainingEl.textContent = `$${cashAfterTrade.toFixed(2)}`;
            }

            checkForSavedSession();
            updateTriggerFormVisibility();
            authButtonText.textContent = isLoginMode ? 'Iniciar Sesi칩n' : 'Crear Cuenta';
        });
    </script>
</body>
</html>